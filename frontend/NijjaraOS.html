<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nijjara-OS | ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÖŸáŸäÿØ...</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <script>
      // Debug flag injected from Apps Script template (set in Code.js doGet)
      // Will be an empty string when not provided.
      window.__DEBUG__ = <?!= JSON.stringify(typeof debug !== 'undefined' ? debug : '') ?>;
    </script>

    <style>
      /* --- II. CSS STYLES --- */

      :root {
        --font-family: "Cairo", sans-serif;
        --font-mono: "Share Tech Mono", monospace;
        --color-bg-dark-matter: #07080d;
        --color-bg-glass: rgba(25, 28, 48, 0.6);
        --color-border-glass: rgba(255, 255, 255, 0.15);
        --color-text: #e0e0e0;
        --color-text-muted: #aaa;
        --color-accent-primary: #0078f0;
        --color-accent-secondary: #00a0f0;
        --color-accent-red: #d93030;
        --color-accent-green: #30d970;
        --shadow-depth-md: 0 5px 15px rgba(0, 0, 0, 0.3);
        --shadow-depth-lg: 0 10px 30px rgba(0, 0, 0, 0.4);
      }

      /* --- Global Reset & Body --- */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        background-color: var(--color-bg-dark-matter);
        color: var(--color-text);
        font-family: var(--font-family);
        direction: rtl;
      }

      /* --- 1. BOOT SCREEN (Login) --- */
      #boot-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: #000;
        z-index: 1000;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        transition: opacity 1s ease-out, visibility 1s ease-out;
      }
      #boot-log {
        width: 450px;
        font-family: var(--font-mono);
        font-size: 1rem;
        color: var(--color-accent-green);
      }
      #boot-log p {
        margin-bottom: 5px;
        white-space: pre;
      }
      .login-box {
        display: none;
        flex-direction: column;
        width: 350px;
        margin-top: 20px;
        padding: 25px;
        border: 1px solid var(--color-accent-primary);
        box-shadow: var(--shadow-depth-lg);
        background: var(--color-bg-glass);
        border-radius: 12px;
      }
      .login-box h2 {
        font-family: var(--font-family);
        text-align: center;
        color: var(--color-accent-primary);
        margin-bottom: 20px;
      }
      .login-box input {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--color-text-muted);
        color: var(--color-text);
        padding: 12px;
        margin-bottom: 15px;
        font-family: var(--font-family);
        font-size: 1rem;
        text-align: right;
        border-radius: 5px;
      }
      .login-box input:focus {
        outline: none;
        border-color: var(--color-accent-primary);
        box-shadow: 0 0 8px var(--color-accent-secondary);
      }
      .login-box button {
        background: var(--color-accent-primary);
        border: none;
        color: #fff;
        padding: 12px;
        font-family: var(--font-family);
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 5px;
      }
      .login-box button:hover {
        background: var(--color-accent-secondary);
        box-shadow: var(--shadow-depth-md);
        transform: translateY(-2px);
      }
      #login-feedback {
        color: var(--color-accent-red);
        text-align: center;
        margin-top: 15px;
        height: 20px;
      }

      /* --- 2. NIJJARA-OS INTERFACE (The "Desktop") --- */
      #nijjara-os {
        display: none;
        height: 100vh;
        width: 100vw;
        position: relative;
      }

      /* --- 2.1 The "Holo-Deck" (Desktop Background) --- */
      #holo-deck {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          ellipse at 50% 50%,
          #1a1a2e 0%,
          var(--color-bg-dark-matter) 70%
        );
        z-index: 1;
      }
      #particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: radial-gradient(
          rgba(255, 255, 255, 0.1) 1px,
          transparent 1px
        );
        background-size: 5px 5px;
        animation: pulse 15s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 0.2;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.4;
        }
        100% {
          transform: scale(1);
          opacity: 0.2;
        }
      }

      /* --- 2.3 App Windows --- */
      .app-window {
        position: absolute;
        width: 600px;
        height: 400px;
        z-index: 10;
        background: var(--color-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--color-border-glass);
        border-radius: 12px;
        box-shadow: var(--shadow-depth-lg);
        animation: materialize 0.5s ease-out;
        resize: both;
        overflow: hidden;
        min-width: 300px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        transition: top 0.3s ease, left 0.3s ease, width 0.3s ease,
          height 0.3s ease;
      }
      @keyframes materialize {
        from {
          opacity: 0;
          transform: scale(0.7) rotateY(45deg);
        }
        to {
          opacity: 1;
          transform: scale(1) rotateY(0);
        }
      }
      .window-header {
        width: 100%;
        height: 35px;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 10px;
        cursor: grab;
        flex-shrink: 0;
      }
      .window-header:active {
        cursor: grabbing;
      }
      .window-title {
        font-weight: 700;
        color: var(--color-text);
      }
      .window-controls {
        display: flex;
        gap: 8px;
        flex-grow: 1;
        justify-content: space-between;
      }
      .window-controls-left {
        display: flex;
        gap: 8px;
      }
      .window-controls-right {
        display: flex;
        gap: 8px;
      }
      .window-controls button {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        line-height: 1;
        font-weight: bold;
        color: #000;
      }
      .win-btn-icon {
        background: none;
        color: var(--color-text-muted);
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }
      .win-btn-icon svg {
        width: 12px;
        height: 12px;
        stroke: var(--color-text-muted);
        stroke-width: 3;
      }
      .win-btn-icon:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .win-btn-icon:hover svg {
        stroke: var(--color-text);
      }
      .btn-close {
        background: var(--color-accent-red);
      }
      .btn-min {
        background: #f0a000;
      }
      .btn-max {
        background: var(--color-accent-green);
      }
      .window-content {
        padding: 20px;
        flex-grow: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--color-border-glass) transparent;
      }
      .window-content::-webkit-scrollbar {
        width: 8px;
      }
      .window-content::-webkit-scrollbar-track {
        background: transparent;
      }
      .window-content::-webkit-scrollbar-thumb {
        background-color: var(--color-border-glass);
        border-radius: 8px;
      }
      .window-content h3 {
        color: var(--color-accent-primary);
        border-bottom: 1px solid var(--color-border-glass);
        padding-bottom: 10px;
        margin-bottom: 15px;
      }
      .window-content p {
        margin-bottom: 10px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 100px 1fr;
        gap: 15px;
        align-items: center;
      }
      .form-grid label {
        font-weight: 700;
        color: var(--color-text-muted);
      }
      .form-grid input,
      .form-grid select,
      .form-grid textarea {
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--color-text-muted);
        color: var(--color-text);
        padding: 10px;
        font-family: var(--font-family);
        font-size: 1rem;
        border-radius: 5px;
      }
      .form-grid input:focus,
      .form-grid select:focus,
      .form-grid textarea:focus {
        outline: none;
        border-color: var(--color-accent-primary);
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      .data-table th,
      .data-table td {
        padding: 10px 12px;
        text-align: right;
        border-bottom: 1px solid var(--color-border-glass);
      }
      .data-table th {
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-accent-primary);
      }
      .data-table tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .win-btn {
        background: var(--color-accent-primary);
        border: none;
        color: #fff;
        padding: 10px 15px;
        font-family: var(--font-family);
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 5px;
        margin: 10px 5px 0 0;
      }
      .win-btn:hover {
        background: var(--color-accent-secondary);
        transform: translateY(-2px);
      }
      .win-btn-danger {
        background: var(--color-accent-red);
      }
      .win-btn-danger:hover {
        background: #ff5555;
      }
      .audit-log {
        font-family: var(--font-mono);
        color: var(--color-text);
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        height: 100%;
        overflow-y: auto;
      }

      /* --- 2.4 The "Nexus" (Command Center) --- */
      #nexus {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 600px;
        background: var(--color-bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--color-accent-primary);
        border-radius: 12px;
        box-shadow: var(--shadow-depth-lg),
          0 0 15px var(--color-accent-secondary);
        z-index: 2000;
        padding: 20px;
        display: none;
        animation: nexus-pulse 0.7s ease-out;
      }
      @keyframes nexus-pulse {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }
      #nexus h3 {
        text-align: center;
        color: var(--color-accent-primary);
        margin-bottom: 15px;
      }
      #nexus-input {
        width: 100%;
        padding: 15px;
        font-family: var(--font-family);
        font-size: 1.2rem;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--color-border-glass);
        border-radius: 8px;
        color: var(--color-text);
        text-align: right;
      }
      #nexus-input:focus {
        outline: none;
        border-color: var(--color-accent-primary);
      }
      #nexus-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1999;
        display: none;
      }

      /* --- 2.5 Floating Action Buttons (FAB) - Hierarchical System --- */
      #fab-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 900;
        pointer-events: none;
      }

      /* Base FAB (all levels) */
      .fab {
        position: absolute;
        display: none;
        z-index: 901;
        pointer-events: auto;
      }

      /* FAB Button */
      .fab-button {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      /* Glossy overlay */
      .fab-button::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.3) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.3) 100%
        );
        pointer-events: none;
        border-radius: 50%;
      }

      /* Glass reflection */
      .fab-button::after {
        content: "";
        position: absolute;
        top: -10px;
        left: -10px;
        width: 32px;
        height: 32px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.5) 0%,
          transparent 70%
        );
        border-radius: 50%;
        pointer-events: none;
        filter: blur(6px);
      }

      .fab-button svg {
        width: 32px;
        height: 32px;
        stroke: #fff;
        stroke-width: 2;
        pointer-events: none;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
        position: relative;
        z-index: 1;
      }

      .fab-button:hover {
        transform: scale(1.1);
      }

      /* Module-specific colors */
      .fab[data-module="hrm"] .fab-button {
        background: linear-gradient(
          135deg,
          rgb(147, 51, 234) 0%,
          rgb(126, 34, 206) 100%
        );
      }
      .fab[data-module="hrm"] .fab-button:hover {
        box-shadow: 0 20px 60px rgba(147, 51, 234, 0.6),
          0 0 40px rgba(147, 51, 234, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .fab[data-module="prj"] .fab-button {
        background: linear-gradient(
          135deg,
          rgb(5, 150, 105) 0%,
          rgb(4, 120, 87) 100%
        );
      }
      .fab[data-module="prj"] .fab-button:hover {
        box-shadow: 0 20px 60px rgba(5, 150, 105, 0.6),
          0 0 40px rgba(5, 150, 105, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .fab[data-module="fin"] .fab-button {
        background: linear-gradient(
          135deg,
          rgb(217, 119, 6) 0%,
          rgb(180, 83, 9) 100%
        );
      }
      .fab[data-module="fin"] .fab-button:hover {
        box-shadow: 0 20px 60px rgba(217, 119, 6, 0.6),
          0 0 40px rgba(217, 119, 6, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      .fab[data-module="sys"] .fab-button {
        background: linear-gradient(
          135deg,
          rgb(8, 145, 178) 0%,
          rgb(21, 94, 117) 100%
        );
      }
      .fab[data-module="sys"] .fab-button:hover {
        box-shadow: 0 20px 60px rgba(8, 145, 178, 0.6),
          0 0 40px rgba(8, 145, 178, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }

      /* Ray container */
      .fab-rays {
        position: absolute;
        top: 32px;
        left: 32px;
        pointer-events: none;
      }

      /* Individual ray */
      .fab-ray {
        position: absolute;
        transform-origin: 0 0;
        pointer-events: auto;
        opacity: 0;
        transform: scale(0);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* Show rays on hover */
      .fab:hover .fab-ray {
        opacity: 1;
        transform: scale(1);
      }

      /* Staggered animation delays */
      .fab-ray:nth-child(1) {
        transition-delay: 0.05s;
      }
      .fab-ray:nth-child(2) {
        transition-delay: 0.1s;
      }
      .fab-ray:nth-child(3) {
        transition-delay: 0.15s;
      }
      .fab-ray:nth-child(4) {
        transition-delay: 0.2s;
      }
      .fab-ray:nth-child(5) {
        transition-delay: 0.25s;
      }
      .fab-ray:nth-child(6) {
        transition-delay: 0.3s;
      }

      /* Ray button */
      .fab-ray-button {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.3);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.95);
      }

      .fab-ray-button::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.6) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.1) 100%
        );
        pointer-events: none;
        border-radius: 50%;
      }

      .fab-ray-button::after {
        content: "";
        position: absolute;
        top: -6px;
        left: -6px;
        width: 20px;
        height: 20px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.8) 0%,
          transparent 70%
        );
        border-radius: 50%;
        pointer-events: none;
        filter: blur(4px);
      }

      .fab-ray-button svg {
        width: 24px;
        height: 24px;
        stroke-width: 2;
        filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.3));
        position: relative;
        z-index: 1;
      }

      /* Color inheritance from parent module */
      .fab[data-module="hrm"] .fab-ray-button svg {
        stroke: rgb(147, 51, 234);
      }
      .fab[data-module="prj"] .fab-ray-button svg {
        stroke: rgb(5, 150, 105);
      }
      .fab[data-module="fin"] .fab-ray-button svg {
        stroke: rgb(217, 119, 6);
      }
      .fab[data-module="sys"] .fab-ray-button svg {
        stroke: rgb(8, 145, 178);
      }

      .fab-ray-button:hover {
        transform: scale(1.15);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }

      /* Ray label */
      .fab-ray-label {
        position: absolute;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-family: var(--font-family);
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .fab-ray-button:hover + .fab-ray-label {
        opacity: 1;
      }

      /* Level 2 FAB (spawned from ray click) - smaller */
      .fab[data-level="2"] .fab-button {
        width: 52px;
        height: 52px;
      }

      .fab[data-level="2"] .fab-button svg {
        width: 26px;
        height: 26px;
      }

      .fab[data-level="2"] .fab-ray-button {
        width: 40px;
        height: 40px;
      }

      .fab[data-level="2"] .fab-ray-button svg {
        width: 20px;
        height: 20px;
      }

      /* --- 2.6 Top Control Bar (Fixed) --- */
      #top-control-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        z-index: 9998;
        background: var(--color-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-bottom: 1px solid var(--color-border-glass);
        box-shadow: var(--shadow-depth-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }

      #user-info {
        color: var(--color-text);
        font-weight: 700;
        font-family: var(--font-family);
        font-size: 1rem;
      }

      #date-time {
        direction: ltr;
        text-align: left;
        color: var(--color-accent-green);
        font-family: var(--font-mono);
        font-size: 0.9rem;
        min-width: 200px;
      }

      #logout-btn {
        background: var(--color-accent-red);
        border: none;
        color: #fff;
        padding: 8px 16px;
        font-family: var(--font-family);
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 6px;
      }

      #logout-btn:hover {
        background: #ff5555;
        transform: translateY(-2px);
        box-shadow: var(--shadow-depth-md);
      }

      /* --- 2.7 Five-Engine Hub System --- */
      #five-engine-hub {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 600px;
        height: 600px;
        z-index: 1000;
        pointer-events: none;
      }

      #five-engine-hub.compact {
        top: 50%;
        left: calc(100% - 50px);
        width: 80px;
        height: 80px;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      /* Central Search Hub */
      #central-search {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        pointer-events: auto;
        opacity: 1;
        transition: all 0.4s ease;
      }

      #five-engine-hub.compact #central-search {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0);
      }

      #search-input {
        width: 100%;
        padding: 18px 24px;
        background: var(--color-bg-glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 2px solid var(--color-accent-primary);
        border-radius: 50px;
        color: var(--color-text);
        font-family: var(--font-family);
        font-size: 1.1rem;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 120, 240, 0.3),
          0 0 40px rgba(0, 120, 240, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transition: all 0.3s;
      }

      #search-input:focus {
        outline: none;
        border-color: var(--color-accent-secondary);
        box-shadow: 0 20px 80px rgba(0, 160, 240, 0.4),
          0 0 60px rgba(0, 160, 240, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      #search-input::placeholder {
        color: var(--color-text-muted);
      }

      /* Orbiting Module Buttons */
      .orbit-module {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border: 3px solid rgba(255, 255, 255, 0.2);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        animation: orbit 20s linear infinite;
        transform-origin: center;
      }

      #five-engine-hub.compact .orbit-module {
        opacity: 0;
        transform: scale(0);
      }

      /* Glossy overlay */
      .orbit-module::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.3) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.3) 100%
        );
        pointer-events: none;
        border-radius: 50%;
        z-index: 1;
      }

      /* Glass reflection */
      .orbit-module::after {
        content: "";
        position: absolute;
        top: -15px;
        left: -15px;
        width: 50px;
        height: 50px;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.6) 0%,
          transparent 70%
        );
        border-radius: 50%;
        pointer-events: none;
        filter: blur(10px);
        z-index: 2;
      }

      .orbit-module-icon {
        width: 50px;
        height: 50px;
        position: relative;
        z-index: 3;
      }

      .orbit-module-icon svg {
        width: 100%;
        height: 100%;
        stroke: #fff;
        stroke-width: 2;
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.6));
      }

      .orbit-module-label {
        font-family: var(--font-family);
        font-size: 0.75rem;
        font-weight: 700;
        color: #fff;
        margin-top: 6px;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        position: relative;
        z-index: 3;
      }

      .orbit-module:hover {
        transform: scale(1.2) translateZ(50px);
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6), 0 0 60px currentColor,
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      /* Module-specific colors and positions */
      #module-hrm {
        top: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(
          135deg,
          rgb(147, 51, 234) 0%,
          rgb(126, 34, 206) 100%
        );
        animation-delay: 0s;
      }

      #module-prj {
        top: 50%;
        right: 50px;
        transform: translateY(-50%);
        background: linear-gradient(
          135deg,
          rgb(5, 150, 105) 0%,
          rgb(4, 120, 87) 100%
        );
        animation-delay: -5s;
      }

      #module-fin {
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(
          135deg,
          rgb(217, 119, 6) 0%,
          rgb(180, 83, 9) 100%
        );
        animation-delay: -10s;
      }

      #module-sys {
        top: 50%;
        left: 50px;
        transform: translateY(-50%);
        background: linear-gradient(
          135deg,
          rgb(8, 145, 178) 0%,
          rgb(21, 94, 117) 100%
        );
        animation-delay: -15s;
      }

      @keyframes orbit {
        0% {
          transform: rotate(0deg) translateX(0) rotate(0deg);
        }
        100% {
          transform: rotate(360deg) translateX(0) rotate(-360deg);
        }
      }

      /* Compact Orb */
      #compact-orb {
        position: fixed;
        top: 50%;
        right: 30px;
        transform: translateY(-50%) scale(0);
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          rgb(37, 99, 235) 0%,
          rgb(29, 78, 216) 100%
        );
        box-shadow: 0 20px 60px rgba(37, 99, 235, 0.6),
          0 0 40px rgba(37, 99, 235, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        border: 3px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        pointer-events: none;
        z-index: 1001;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #compact-orb.visible {
        transform: translateY(-50%) scale(1);
        pointer-events: auto;
      }

      #compact-orb::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.3) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.3) 100%
        );
        border-radius: 50%;
      }

      #compact-orb svg {
        width: 40px;
        height: 40px;
        stroke: #fff;
        stroke-width: 2;
        position: relative;
        z-index: 1;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
      }

      #compact-orb:hover {
        transform: translateY(-50%) scale(1.15);
        box-shadow: 0 30px 80px rgba(37, 99, 235, 0.7),
          0 0 60px rgba(37, 99, 235, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }

      /* --- 2.6 Module Drawer System (Phase 2) --- */
      body.drawer-open #holo-deck,
      body.drawer-open #particles {
        filter: blur(5px) brightness(0.9);
      }
      body.drawer-open #five-engine-hub {
        pointer-events: none; /* prevent accidental clicks on hub while drawer open */
      }
      body.drawer-open #five-engine-hub .orbit-module:not(.active) {
        filter: blur(4px);
        opacity: 0.4;
      }
      .orbit-module.active {
        position: fixed;
        top: 90px;
        left: 50%;
        transform: translateX(-50%) scale(1.2);
        z-index: 2002;
        animation: none; /* stop orbit */
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6), 0 0 60px currentColor,
          inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }
      #module-drawer-overlay {
        position: fixed;
        inset: 0;
        z-index: 2000;
        display: none;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(6px);
        -webkit-backdrop-filter: blur(6px);
      }
      #module-drawer-overlay.visible {
        display: block;
      }
      #module-drawer {
        position: fixed;
        top: 160px;
        left: 50%;
        transform: translateX(-50%) scale(0.9);
        z-index: 2003;
        display: none;
        width: 640px;
        height: 360px;
        pointer-events: auto;
      }
      #module-drawer.visible {
        display: block;
        animation: drawer-unfold 300ms ease-out;
      }
      @keyframes drawer-unfold {
        from {
          opacity: 0;
          transform: translateX(-50%) scale(0.8);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) scale(0.95);
        }
      }
      #module-submodules {
        position: absolute;
        inset: 0;
        display: block;
      }
      .drawer-submodule {
        position: absolute;
        width: 88px;
        height: 88px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.15),
          rgba(0, 0, 0, 0.25)
        );
        border: 2px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
        color: #fff;
        cursor: pointer;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        overflow: hidden;
      }
      .drawer-submodule:hover {
        transform: scale(1.08);
        box-shadow: 0 24px 64px rgba(0, 0, 0, 0.6);
      }
      .drawer-submodule .icon {
        width: 36px;
        height: 36px;
        z-index: 1;
      }
      .drawer-submodule .icon svg {
        width: 100%;
        height: 100%;
        stroke: #fff;
        stroke-width: 2;
        filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
      }
      .drawer-submodule .label {
        font-size: 11px;
        font-weight: 700;
        margin-top: 6px;
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        z-index: 1;
      }
      .drawer-submodule::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 50%;
        pointer-events: none;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.25),
          transparent 50%,
          rgba(0, 0, 0, 0.35)
        );
      }
      .drawer-submodule::after {
        content: "";
        position: absolute;
        top: -8px;
        left: -8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.5) 0%,
          transparent 70%
        );
        filter: blur(5px);
        pointer-events: none;
      }
      #module-drawer-close {
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      }
      #module-drawer-close:hover {
        transform: translateX(-50%) scale(1.08);
      }

      /* --- 2.8 Task Switcher --- */
      #task-switcher {
        position: fixed;
        top: -55px; /* ÿ•ÿÆŸÅÿßÿ° ÿ™ŸÑŸÇÿßÿ¶Ÿä */
        left: 50%;
        transform: translateX(-50%);
        height: 60px;
        z-index: 998;
        background: var(--color-bg-glass);
        border: 1px solid var(--color-border-glass);
        border-radius: 0 0 12px 12px;
        box-shadow: var(--shadow-depth-md);
        padding: 5px 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: top 0.3s ease;
      }

      #task-switcher:hover {
        top: 0; /* ÿ•ÿ∏Ÿáÿßÿ± ÿπŸÜÿØ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
      }

      .task-thumb {
        width: 100px;
        height: 50px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--color-border-glass);
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        overflow: hidden;
        transition: all 0.2s ease;
      }
      .task-thumb:hover {
        transform: scale(1.1);
        border-color: var(--color-accent-primary);
      }
      .task-thumb.minimized {
        opacity: 0.6;
        background: rgba(0, 0, 0, 0.6);
      }
      .task-thumb-icon {
        width: 20px;
        height: 20px;
      }
      .task-thumb-icon svg {
        width: 100%;
        height: 100%;
        stroke: var(--color-text-muted);
      }
      .task-thumb-title {
        font-family: var(--font-family);
        font-size: 0.7rem;
        color: var(--color-text-muted);
        white-space: nowrap;
      }

      /* --- 2.8 Toast Notifications --- */
      #toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 300px;
        max-width: 400px;
      }
      .toast {
        background: var(--color-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--color-border-glass);
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: var(--shadow-depth-lg);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideInRight 0.5s ease-out;
        position: relative;
        overflow: hidden;
      }
      .toast::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--toast-color, var(--color-accent-primary));
      }
      .toast.success {
        --toast-color: var(--color-accent-green);
      }
      .toast.error {
        --toast-color: var(--color-accent-red);
      }
      .toast.warning {
        --toast-color: #f0a000;
      }
      .toast.info {
        --toast-color: var(--color-accent-primary);
      }
      .toast-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--toast-color, var(--color-accent-primary));
        flex-shrink: 0;
      }
      .toast-icon svg {
        width: 16px;
        height: 16px;
        stroke: #fff;
        stroke-width: 2;
      }
      .toast-content {
        flex: 1;
        font-family: var(--font-family);
      }
      .toast-title {
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 4px;
      }
      .toast-message {
        font-size: 0.9rem;
        color: var(--color-text-muted);
      }
      .toast-close {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s;
      }
      .toast-close:hover {
        color: var(--color-text);
      }
      .toast-close svg {
        width: 16px;
        height: 16px;
        stroke: currentColor;
        stroke-width: 2;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .toast.hiding {
        animation: slideOutRight 0.3s ease-out forwards;
      }
      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }

      /* --- 2.9 (ÿ¨ÿØŸäÿØ) ÿ¥ÿ±Ÿäÿ∑ ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä --- */
      #window-action-bar {
        position: fixed;
        left: -55px; /* ÿ•ÿÆŸÅÿßÿ° ÿ™ŸÑŸÇÿßÿ¶Ÿä - RTL friendly */
        top: 50%;
        transform: translateY(-50%);
        width: 60px;
        z-index: 998;
        background: var(--color-bg-glass);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--color-border-glass);
        border-radius: 0 12px 12px 0; /* RTL friendly */
        box-shadow: var(--shadow-depth-md);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        transition: left 0.3s ease;
      }
      #window-action-bar:hover {
        left: 0; /* ÿ•ÿ∏Ÿáÿßÿ± ÿπŸÜÿØ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± */
      }
      .action-bar-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .action-bar-btn svg {
        width: 20px;
        height: 20px;
        stroke: var(--color-text-muted);
        stroke-width: 2;
      }
      .action-bar-btn:hover {
        background: var(--color-accent-primary);
      }
      .action-bar-btn:hover svg {
        stroke: #fff;
      }
    </style>
  </head>
  <body>
    <svg width="0" height="0" style="position: absolute">
      <defs>
        <symbol
          id="icon-hrm"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </symbol>
        <symbol
          id="icon-prj"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
          ></path>
          <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
          <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </symbol>
        <symbol
          id="icon-fin"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </symbol>
        <symbol
          id="icon-sys"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
          ></path>
        </symbol>
        <symbol
          id="icon-power"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
          <line x1="12" y1="2" x2="12" y2="12"></line>
        </symbol>
        <symbol
          id="icon-grid"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </symbol>
        <symbol
          id="icon-layers"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
          <polyline points="2 17 12 22 22 17"></polyline>
          <polyline points="2 12 12 17 22 12"></polyline>
        </symbol>
        <symbol
          id="icon-maximize"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"
          ></path>
        </symbol>
        <symbol
          id="icon-restore"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"
          ></path>
        </symbol>
        <symbol
          id="icon-eye"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </symbol>
        <symbol
          id="icon-plus"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </symbol>
        <symbol
          id="icon-search"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </symbol>
        <symbol
          id="icon-minus"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </symbol>
        <symbol
          id="icon-check"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="20 6 9 17 4 12"></polyline>
        </symbol>
        <symbol
          id="icon-x"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </symbol>
        <symbol
          id="icon-alert"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
          ></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </symbol>
        <symbol
          id="icon-info"
          viewBox="0 0 24 24"
          fill="none"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </symbol>
      </defs>
    </svg>

    <div id="boot-screen">
      <div id="boot-log"></div>
      <div class="login-box" id="login-box">
        <h2>ŸÖŸÅÿ™ÿßÿ≠ ŸÖÿµÿßÿØŸÇÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ</h2>
        <input
          type="text"
          id="username"
          placeholder="ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ"
          value="mkhoraiby"
        />
        <input
          type="password"
          id="password"
          placeholder="ÿ±ŸÖÿ≤ ÿßŸÑÿØÿÆŸàŸÑ"
          value="210388"
        />
        <button id="login-button">ŸàŸÑŸàÿ¨</button>
        <div id="login-feedback"></div>
      </div>
    </div>

    <div id="nijjara-os">
      <!-- Toast Notification Container -->
      <div id="toast-container"></div>

      <!-- Background -->
      <div id="holo-deck">
        <div id="particles"></div>
      </div>

      <!-- Top Control Bar (Fixed) -->
      <div id="top-control-bar">
        <div id="user-info">USER: ...</div>
        <div id="date-time">Loading clock...</div>
        <button id="logout-btn">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
      </div>

      <!-- Five-Engine Hub System -->
      <div id="five-engine-hub">
        <!-- Central Search -->
        <div id="central-search">
          <input
            type="text"
            id="search-input"
            placeholder="üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£Ÿä ÿ¥Ÿäÿ°..."
          />
        </div>

        <!-- Orbiting Module Buttons -->
        <div class="orbit-module" id="module-hrm" data-module="hrm">
          <div class="orbit-module-icon">
            <svg><use href="#icon-hrm"></use></svg>
          </div>
          <div class="orbit-module-label">ÿßŸÑŸÖŸàÿßÿ±ÿØ ÿßŸÑÿ®ÿ¥ÿ±Ÿäÿ©</div>
        </div>

        <div class="orbit-module" id="module-prj" data-module="prj">
          <div class="orbit-module-icon">
            <svg><use href="#icon-prj"></use></svg>
          </div>
          <div class="orbit-module-label">ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</div>
        </div>

        <div class="orbit-module" id="module-fin" data-module="fin">
          <div class="orbit-module-icon">
            <svg><use href="#icon-fin"></use></svg>
          </div>
          <div class="orbit-module-label">ÿßŸÑŸÖÿßŸÑŸäÿ©</div>
        </div>

        <div class="orbit-module" id="module-sys" data-module="sys">
          <div class="orbit-module-icon">
            <svg><use href="#icon-sys"></use></svg>
          </div>
          <div class="orbit-module-label">ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
        </div>
      </div>

      <!-- Module Drawer (Phase 2) -->
      <div id="module-drawer-overlay"></div>
      <div id="module-drawer">
        <div id="module-submodules"></div>
        <button id="module-drawer-close" title="ÿ•ÿ∫ŸÑÿßŸÇ">√ó</button>
      </div>

      <!-- Compact Orb (Right Side) -->
      <div id="compact-orb">
        <svg><use href="#icon-grid"></use></svg>
      </div>

      <!-- Task Switcher (Top Auto-Hide) -->
      <div id="task-switcher"></div>

      <!-- Window Action Bar (Left Auto-Hide) -->
      <div id="window-action-bar">
        <div class="action-bar-btn" id="app-grid" title="ÿ™ÿ±ÿ™Ÿäÿ® ÿ¥ÿ®ŸÉŸä">
          <svg><use href="#icon-grid"></use></svg>
        </div>
        <div class="action-bar-btn" id="app-cascade" title="ÿ™ÿ±ÿ™Ÿäÿ® ŸÖÿ™ÿ™ÿßŸÑŸä">
          <svg><use href="#icon-layers"></use></svg>
        </div>
        <div class="action-bar-btn" id="app-minimize-all" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑŸÉŸÑ">
          <svg><use href="#icon-minus"></use></svg>
        </div>
        <div class="action-bar-btn" id="app-expand-all" title="ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÉŸÑ">
          <svg><use href="#icon-maximize"></use></svg>
        </div>
      </div>
    </div>

    <template id="window-template">
      <div class="app-window">
        <div class="window-header">
          <div class="window-controls">
            <div class="window-controls-right">
              <button
                class="win-btn-icon btn-toggle-fab"
                title="ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≤ÿ± ÿßŸÑÿπÿßÿ¶ŸÖ"
              >
                <svg><use href="#icon-eye"></use></svg>
              </button>
            </div>
            <span class="window-title">ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©</span>
            <div class="window-controls-left">
              <button class="win-btn-icon btn-min" title="ÿ™ÿµÿ∫Ÿäÿ±">
                <svg>
                  <use
                    href="#icon-minus"
                    style="stroke-width: 4; transform: scale(0.8)"
                  ></use>
                </svg>
              </button>
              <button class="win-btn-icon btn-max" title="ÿ™ŸÉÿ®Ÿäÿ±">
                <svg><use href="#icon-maximize"></use></svg>
              </button>
              <button class="win-btn-icon btn-close" title="ÿ•ÿ∫ŸÑÿßŸÇ">
                <svg>
                  <use
                    href="#icon-plus"
                    style="stroke-width: 4; transform: rotate(45deg) scale(0.8)"
                  ></use>
                </svg>
              </button>
            </div>
          </div>
        </div>
        <div class="window-content"></div>
      </div>
    </template>

    <template id="task-thumb-template">
      <div class="task-thumb">
        <div class="task-thumb-icon">
          <svg><use href="#icon-sys"></use></svg>
        </div>
        <span class="task-thumb-title">Window</span>
      </div>
    </template>

    <script>
      /* --- III. JAVASCRIPT "OS KERNEL" --- */

      document.addEventListener("DOMContentLoaded", () => {
        // --- Toast Notification System ---
        function showToast(title, message, type = "info", duration = 4000) {
          const container = document.getElementById("toast-container");
          const toast = document.createElement("div");
          toast.className = `toast ${type}`;

          const iconMap = {
            success: "icon-check",
            error: "icon-x",
            warning: "icon-alert",
            info: "icon-info",
          };

          toast.innerHTML = `
                    <div class="toast-icon">
                        <svg><use href="#${
                          iconMap[type] || "icon-info"
                        }"></use></svg>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">
                        <svg><use href="#icon-x"></use></svg>
                    </button>
                `;

          container.appendChild(toast);

          // Close button handler
          const closeBtn = toast.querySelector(".toast-close");
          closeBtn.addEventListener("click", () => {
            toast.classList.add("hiding");
            setTimeout(() => toast.remove(), 300);
          });

          // Auto-dismiss
          if (duration > 0) {
            setTimeout(() => {
              if (toast.parentElement) {
                toast.classList.add("hiding");
                setTimeout(() => toast.remove(), 300);
              }
            }, duration);
          }

          return toast;
        }

        // --- 1. Element Selectors ---
        const bootScreen = document.getElementById("boot-screen");
        const bootLog = document.getElementById("boot-log");
        const loginBox = document.getElementById("login-box");
        const loginButton = document.getElementById("login-button");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const nijjaraOS = document.getElementById("nijjara-os");
        const windowTemplate = document.getElementById("window-template");
        const fabContainer = document.getElementById("fab-container");

        const taskSwitcher = document.getElementById("task-switcher");
        const taskThumbTemplate = document.getElementById(
          "task-thumb-template"
        );

        const nexus = document.getElementById("nexus");
        const nexusOverlay = document.getElementById("nexus-overlay");

        // --- 2. Boot Sequence & Login ---
        const bootMessages = [
          "BOOTING NIJJARA-OS v1.0...",
          "Loading kernel modules... OK",
          "Initializing 3D glass display... DONE",
          "Connecting to neural-link... SECURE",
          "Loading user authentication service...",
          "Awaiting system key...",
        ];

        let i = 0;
        function runBootLog() {
          if (i < bootMessages.length) {
            const p = document.createElement("p");
            p.textContent = `> ${bootMessages[i]}`;
            bootLog.appendChild(p);
            bootLog.scrollTop = bootLog.scrollHeight;
            i++;
            setTimeout(runBootLog, Math.random() * 300 + 100);
          } else {
            loginBox.style.display = "flex";
          }
        }

        loginButton.addEventListener("click", handleLogin);
        passwordInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") handleLogin();
        });

        function handleLogin() {
          const user = usernameInput.value.trim();
          const pass = passwordInput.value;

          if (!user || !pass) {
            document.getElementById("login-feedback").textContent =
              "ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±";
            logToConsole(
              "Login validation failed: empty fields",
              "CLIENT-ERROR"
            );
            return;
          }

          loginButton.disabled = true;
          loginButton.textContent = "ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿµÿßÿØŸÇÿ©...";
          document.getElementById("login-feedback").textContent = "";

          logToConsole(`Attempting login for user: ${user}`, "CLIENT-INFO");

          // Call backend authentication
          google.script.run
            .withSuccessHandler(function (response) {
              loginButton.disabled = false;
              loginButton.textContent = "ŸàŸÑŸàÿ¨";

              if (response && response.success) {
                logToConsole(
                  "Login successful. Session active.",
                  "CLIENT-SUCCESS"
                );

                // Store session data
                sessionStorage.setItem(
                  "nijjara_session",
                  JSON.stringify(response.data)
                );

                // Show success toast
                showToast(
                  "ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠",
                  `ŸÖÿ±ÿ≠ÿ®ÿßŸã ${response.data.username}ÿå ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ`,
                  "success",
                  3000
                );

                // Boot into OS with slight delay for toast visibility
                setTimeout(() => {
                  bootScreen.style.opacity = "0";
                  bootScreen.style.visibility = "hidden";
                  nijjaraOS.style.display = "block";

                  document.getElementById(
                    "user-info"
                  ).textContent = `USER: ${response.data.username}`;
                  startClock();
                }, 500);
              } else {
                logToConsole(
                  "Login failed: " + response.message,
                  "CLIENT-ERROR"
                );
                document.getElementById("login-feedback").textContent =
                  response.message || "ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ";
              }
            })
            .withFailureHandler(function (error) {
              loginButton.disabled = false;
              loginButton.textContent = "ŸàŸÑŸàÿ¨";
              logToConsole("Login error: " + error.message, "CLIENT-ERROR");
              document.getElementById("login-feedback").textContent =
                "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ";
            })
            .authenticateUser(user, pass);
        }
        runBootLog();

        function startClock() {
          const dateTimeEl = document.getElementById("date-time");
          if (!dateTimeEl) return;

          function updateTime() {
            const now = new Date();
            const date = now.toLocaleDateString("ar-EG-u-nu-latn", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
            });
            const time = now.toLocaleTimeString("en-US", {
              hour12: true,
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            dateTimeEl.textContent = `${date} | ${time}`;
          }
          updateTime();
          setInterval(updateTime, 1000);
        }

        // --- 3. Window Manager ---
        let windowCount = 0;
        let highestZ = 10;
        const moduleIcons = {
          hrm: "#icon-hrm",
          prj: "#icon-prj",
          fin: "#icon-fin",
          sys: "#icon-sys",
        };

        function createWindow(title, content, moduleId) {
          windowCount++;
          highestZ++;

          const template = windowTemplate.content.cloneNode(true);
          const newWindow = template.querySelector(".app-window");

          const windowId = `window-${moduleId}-${Date.now()}`;
          newWindow.id = windowId;

          newWindow.style.top = `${50 + windowCount * 20}px`;
          newWindow.style.left = `${100 + windowCount * 20}px`;
          newWindow.style.zIndex = highestZ;
          newWindow.dataset.moduleId = moduleId;

          newWindow.querySelector(".window-title").textContent = title;
          newWindow.querySelector(".window-content").innerHTML = content;

          addTaskThumb(windowId, moduleId, title);

          // ÿ•ÿ∫ŸÑÿßŸÇ
          newWindow
            .querySelector(".btn-close")
            .addEventListener("click", () => {
              removeTaskThumb(windowId);
              newWindow.remove();
            });

          // ÿ™ÿµÿ∫Ÿäÿ±
          newWindow.querySelector(".btn-min").addEventListener("click", () => {
            newWindow.style.display = "none";
            document
              .querySelector(`.task-thumb[data-window-id="${windowId}"]`)
              ?.classList.add("minimized");
          });

          // ÿ™ŸÉÿ®Ÿäÿ±/ÿßÿ≥ÿ™ÿπÿßÿØÿ©
          newWindow.querySelector(".btn-max").addEventListener("click", (e) => {
            maximizeWindow(newWindow, e.currentTarget);
          });

          // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≤ÿ± ÿßŸÑÿπÿßÿ¶ŸÖ
          newWindow
            .querySelector(".btn-toggle-fab")
            .addEventListener("click", () => {
              toggleFabForModule(moduleId);
            });

          newWindow.addEventListener("mousedown", () => {
            bringWindowToFront(newWindow);
          });

          makeDraggable(
            newWindow.querySelector(".window-header"),
            newWindow,
            false
          );
          nijjaraOS.appendChild(newWindow);
          // Module specific initializers
          if (moduleId === "hrm") {
            initHRMWindow(newWindow);
          }
          return newWindow;
        }

        function bringWindowToFront(windowEl) {
          highestZ++;
          windowEl.style.zIndex = highestZ;
          windowEl.style.display = "block";
          document
            .querySelector(`.task-thumb[data-window-id="${windowEl.id}"]`)
            ?.classList.remove("minimized");
        }

        function maximizeWindow(windowEl, btn) {
          const icon = btn.querySelector("svg use");
          if (windowEl.dataset.isMaximized === "true") {
            // Restore
            windowEl.style.top = windowEl.dataset.oldTop;
            windowEl.style.left = windowEl.dataset.oldLeft;
            windowEl.style.width = windowEl.dataset.oldWidth;
            windowEl.style.height = windowEl.dataset.oldHeight;
            windowEl.dataset.isMaximized = "false";
            icon.setAttribute("href", "#icon-maximize");
          } else {
            // Maximize
            windowEl.dataset.oldTop = windowEl.style.top;
            windowEl.dataset.oldLeft = windowEl.style.left;
            windowEl.dataset.oldWidth = windowEl.style.width;
            windowEl.dataset.oldHeight = windowEl.style.height;
            windowEl.style.top = "0";
            windowEl.style.left = "0";
            windowEl.style.width = "100vw";
            windowEl.style.height = "100vh";
            windowEl.dataset.isMaximized = "true";
            icon.setAttribute("href", "#icon-restore");
          }
        }

        // (ÿ™ÿπÿØŸäŸÑ) Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ≥ÿ≠ÿ®
        function makeDraggable(header, windowEl, isFab = false) {
          let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0;
          let isDragging = false;

          header.onmousedown = dragMouseDown;

          function dragMouseDown(e) {
            if (e.target.closest("button") && !isFab) return;

            isDragging = false;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
            e.preventDefault();
            isDragging = true;

            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàÿ∂ÿπ
            windowEl.style.top = windowEl.offsetTop - pos2 + "px";
            windowEl.style.left = windowEl.offsetLeft - pos1 + "px";
          }

          function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;

            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿ≤ÿ±ÿßŸã ÿπÿßÿ¶ŸÖÿßŸã ŸàŸÑŸÖ Ÿäÿ™ŸÖ ÿ≥ÿ≠ÿ®Ÿáÿå ÿßÿπÿ™ÿ®ÿ±Ÿá "ŸÜŸÇÿ±"
            if (isFab && !isDragging) {
              windowEl.classList.toggle("active");
            }
          }
        }

        // --- Window Arrangement Functions ---
        function arrangeWindowsInGrid() {
          logToConsole("Arranging windows in grid...", "CLIENT-EVENT");
          const windows = document.querySelectorAll(
            '.app-window:not([style*="display: none"])'
          );
          const numWindows = windows.length;
          if (numWindows === 0) return;
          const cols = Math.ceil(Math.sqrt(numWindows));
          const rows = Math.ceil(numWindows / cols);
          const winWidth = window.innerWidth / cols;
          const winHeight = window.innerHeight / rows;

          windows.forEach((win, index) => {
            const row = Math.floor(index / cols);
            const col = index % cols;
            win.style.top = `${row * winHeight}px`;
            win.style.left = `${col * winWidth}px`;
            win.style.width = `${winWidth}px`;
            win.style.height = `${winHeight}px`;
          });
        }

        function arrangeWindowsCascade() {
          logToConsole("Arranging windows in cascade...", "CLIENT-EVENT");
          const windows = document.querySelectorAll(
            '.app-window:not([style*="display: none"])'
          );
          windows.forEach((win, index) => {
            win.style.top = `${50 + index * 40}px`;
            win.style.left = `${100 + index * 40}px`;
            win.style.width = "600px";
            win.style.height = "400px";
            win.style.zIndex = 10 + index;
          });
        }

        function minimizeAllWindows() {
          logToConsole("Minimizing all windows", "CLIENT-EVENT");
          document.querySelectorAll(".app-window").forEach((win) => {
            win.style.display = "none";
            document
              .querySelector(`.task-thumb[data-window-id="${win.id}"]`)
              ?.classList.add("minimized");
          });
        }

        function expandAllWindows() {
          logToConsole("Expanding all windows", "CLIENT-EVENT");
          document
            .querySelectorAll('.app-window[style*="display: none"]')
            .forEach((win) => {
              win.style.display = "block";
              document
                .querySelector(`.task-thumb[data-window-id="${win.id}"]`)
                ?.classList.remove("minimized");
            });
        }

        // --- 4. Five-Engine Module Handlers ---

        function openOrFocusWindow(moduleId, title, content, fabConfig) {
          logToConsole(`Loading ${moduleId}_Module...`, "CLIENT-INFO");
          const existing = document.querySelector(
            `.app-window[data-module-id="${moduleId}"]`
          );
          if (existing) {
            bringWindowToFront(existing);
            return existing;
          }
          if (fabConfig) {
            ensureFabExists(moduleId, fabConfig.icon, fabConfig.subModules);
          }
          return createWindow(title, content, moduleId);
        }

        // --- Five-Engine Hub System Initialization ---
        const fiveEngineHub = document.getElementById("five-engine-hub");
        const compactOrb = document.getElementById("compact-orb");
        const searchInput = document.getElementById("search-input");
        const moduleDrawer = document.getElementById("module-drawer");
        const moduleDrawerOverlay = document.getElementById(
          "module-drawer-overlay"
        );
        const moduleSubmodules = document.getElementById("module-submodules");
        const moduleDrawerClose = document.getElementById(
          "module-drawer-close"
        );

        // Logout Button
        document.getElementById("logout-btn").addEventListener("click", () => {
          logToConsole("Logging out...", "CLIENT-INFO");
          sessionStorage.removeItem("nijjara_session");
          google.script.run
            .withSuccessHandler(function () {
              location.reload();
            })
            .withFailureHandler(function () {
              location.reload();
            })
            .logoutUser();
        });

        // Compact Orb Toggle
        compactOrb.addEventListener("click", () => {
          fiveEngineHub.classList.remove("compact");
          compactOrb.classList.remove("visible");
          // Telemetry: hub expanded by compact orb
          try {
            const activeModule =
              document
                .querySelector("#five-engine-hub .orbit-module.active")
                ?.getAttribute("data-module") || null;
            window.parent?.postMessage(
              {
                type: "nijjara-status",
                source: "compactOrbExpand",
                module: activeModule,
                hubCompact: false,
                drawerOpen:
                  moduleDrawer?.classList?.contains("visible") || false,
                overlayVisible:
                  moduleDrawerOverlay?.classList?.contains("visible") || false,
                bodyDrawerOpen: document.body.classList.contains("drawer-open"),
                timestamp: Date.now(),
              },
              "*"
            );
          } catch {}
        });

        // Central Search Functionality
        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && searchInput.value.trim()) {
            const query = searchInput.value.trim();
            showToast("ÿ®ÿ≠ÿ´", `ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ: ${query}`, "info", 2000);
            // TODO: Implement smart search logic in Phase 2
            searchInput.value = "";
          }
        });

        // Module Click Handlers (Phase 1: Basic window opening, Phase 2 will add drawer)
        document.getElementById("module-hrm").addEventListener("click", () => {
          openModuleDrawer("hrm");
        });

        document.getElementById("module-prj").addEventListener("click", () => {
          openModuleDrawer("prj");
        });

        document.getElementById("module-fin").addEventListener("click", () => {
          openModuleDrawer("fin");
        });

        document.getElementById("module-sys").addEventListener("click", () => {
          openModuleDrawer("sys");
        });

        // Window Control Listeners (Left Action Bar)
        document
          .getElementById("app-grid")
          .addEventListener("click", arrangeWindowsInGrid);
        document
          .getElementById("app-cascade")
          .addEventListener("click", arrangeWindowsCascade);
        document
          .getElementById("app-minimize-all")
          .addEventListener("click", minimizeAllWindows);
        document
          .getElementById("app-expand-all")
          .addEventListener("click", expandAllWindows);

        // --- 5. Nexus Command Center Logic --- (ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±)
        // ...

        // --- 6. Dynamic Content Listeners --- (ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±)
        // ...

        // --- 7. Hierarchical FAB System ---
        const fabRegistry = new Map(); // Store all FABs by ID
        let fabIdCounter = 0;

        // HRM Module Configuration
        const HRM_SUBMODULES = [
          {
            id: "hrm-employees",
            icon: "#icon-hrm",
            label: "ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ",
            angle: -60,
          },
          {
            id: "hrm-attendance",
            icon: "#icon-grid",
            label: "ÿßŸÑÿ≠ÿ∂Ÿàÿ±",
            angle: -30,
          },
          {
            id: "hrm-deductions",
            icon: "#icon-minus",
            label: "ÿßŸÑÿÆÿµŸàŸÖÿßÿ™",
            angle: 0,
          },
          {
            id: "hrm-overtime",
            icon: "#icon-plus",
            label: "ÿßŸÑÿ•ÿ∂ÿßŸÅŸä",
            angle: 30,
          },
          { id: "hrm-advances", icon: "#icon-fin", label: "ÿßŸÑÿ≥ŸÑŸÅ", angle: 60 },
          { id: "hrm-payroll", icon: "#icon-fin", label: "ÿßŸÑÿ±Ÿàÿßÿ™ÿ®", angle: 90 },
        ];
        const PRJ_SUBMODULES = [
          { id: "prj-projects", icon: "#icon-prj", label: "ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ" },
          { id: "prj-clients", icon: "#icon-hrm", label: "ÿßŸÑÿπŸÖŸÑÿßÿ°" },
          { id: "prj-tasks", icon: "#icon-grid", label: "ÿßŸÑŸÖŸáÿßŸÖ" },
          {
            id: "prj-timesheets",
            icon: "#icon-grid",
            label: "ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©",
          },
        ];
        const FIN_SUBMODULES = [
          { id: "fin-expenses", icon: "#icon-fin", label: "ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™" },
          { id: "fin-income", icon: "#icon-fin", label: "ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™" },
          { id: "fin-invoices", icon: "#icon-fin", label: "ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±" },
          { id: "fin-payments", icon: "#icon-fin", label: "ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™" },
        ];
        const SYS_SUBMODULES = [
          { id: "sys-users", icon: "#icon-sys", label: "ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ" },
          { id: "sys-roles", icon: "#icon-sys", label: "ÿßŸÑÿ£ÿØŸàÿßÿ±" },
          { id: "sys-permissions", icon: "#icon-sys", label: "ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™" },
          { id: "sys-audit", icon: "#icon-info", label: "ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿØŸÇŸäŸÇ" },
        ];

        function getModuleTheme(moduleId) {
          switch (moduleId) {
            case "hrm":
              return {
                color: "rgb(147, 51, 234)",
                gradient:
                  "linear-gradient(135deg, rgba(147,51,234,0.4), rgba(126,34,206,0.35))",
              };
            case "prj":
              return {
                color: "rgb(5, 150, 105)",
                gradient:
                  "linear-gradient(135deg, rgba(5,150,105,0.4), rgba(4,120,87,0.35))",
              };
            case "fin":
              return {
                color: "rgb(217, 119, 6)",
                gradient:
                  "linear-gradient(135deg, rgba(217,119,6,0.4), rgba(180,83,9,0.35))",
              };
            case "sys":
              return {
                color: "rgb(8, 145, 178)",
                gradient:
                  "linear-gradient(135deg, rgba(8,145,178,0.4), rgba(21,94,117,0.35))",
              };
            default:
              return {
                color: "#fff",
                gradient:
                  "linear-gradient(135deg, rgba(255,255,255,0.2), rgba(0,0,0,0.2))",
              };
          }
        }

        function getSubmodules(moduleId) {
          switch (moduleId) {
            case "hrm":
              return HRM_SUBMODULES;
            case "prj":
              return PRJ_SUBMODULES;
            case "fin":
              return FIN_SUBMODULES;
            case "sys":
              return SYS_SUBMODULES;
            default:
              return [];
          }
        }

        function openModuleDrawer(moduleId) {
          // Report current state to parent (for deployment validation telemetry)
          // This emits lightweight status messages consumable by the top-level page via postMessage
          function reportState(source, mod) {
            try {
              const hubCompact =
                fiveEngineHub?.classList?.contains("compact") || false;
              const drawerOpen =
                moduleDrawer?.classList?.contains("visible") || false;
              const overlayVisible =
                moduleDrawerOverlay?.classList?.contains("visible") || false;
              const bodyDrawerOpen =
                document.body.classList.contains("drawer-open");
              const activeModule =
                document
                  .querySelector("#five-engine-hub .orbit-module.active")
                  ?.getAttribute("data-module") || null;
              const payload = {
                type: "nijjara-status",
                source,
                module: mod || activeModule,
                hubCompact,
                drawerOpen,
                overlayVisible,
                bodyDrawerOpen,
                timestamp: Date.now(),
              };
              window.parent?.postMessage(payload, "*");
            } catch (e) {
              console.warn("reportState error", e);
            }
          }
          // Mark selected module active
          document
            .querySelectorAll("#five-engine-hub .orbit-module")
            .forEach((el) => el.classList.remove("active"));
          const activeModuleEl = document.querySelector(
            `#five-engine-hub .orbit-module[data-module="${moduleId}"]`
          );
          if (!activeModuleEl) return;
          activeModuleEl.classList.add("active");

          // Compact the hub and show the compact orb for focused drawer interaction
          fiveEngineHub.classList.add("compact");
          compactOrb.classList.add("visible");

          // Show overlay and drawer
          document.body.classList.add("drawer-open");
          moduleDrawerOverlay.classList.add("visible");
          moduleDrawer.classList.add("visible");
          // Telemetry: drawer opened + hub compacted
          reportState("openModuleDrawer", moduleId);

          // Populate submodules in circular pattern
          const subs = getSubmodules(moduleId);
          moduleSubmodules.innerHTML = "";
          const theme = getModuleTheme(moduleId);
          const centerX = 320; // half of 640
          const centerY = 180; // half of 360
          const radius = 120;
          const total = subs.length;
          subs.forEach((sm, index) => {
            const angle = (2 * Math.PI * index) / total - Math.PI / 2; // start at top
            const x = centerX + radius * Math.cos(angle) - 44; // 88/2 offset
            const y = centerY + radius * Math.sin(angle) - 44;
            const item = document.createElement("div");
            item.className = "drawer-submodule";
            item.style.left = `${x}px`;
            item.style.top = `${y}px`;
            item.style.background = theme.gradient;
            item.innerHTML = `
                        <div class="icon"><svg><use href="${sm.icon}"></use></svg></div>
                        <div class="label">${sm.label}</div>
                    `;
            item.addEventListener("click", () => {
              showToast("ÿßÿÆÿ™Ÿäÿßÿ±", `ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ±: ${sm.label}`, "info", 1500);
              // Future: open window or quick actions (Phase 3/5)
            });
            moduleSubmodules.appendChild(item);
          });
        }

        function closeModuleDrawer() {
          moduleDrawer.classList.remove("visible");
          moduleDrawerOverlay.classList.remove("visible");
          document.body.classList.remove("drawer-open");
          document
            .querySelectorAll("#five-engine-hub .orbit-module")
            .forEach((el) => el.classList.remove("active"));
          // Telemetry: drawer closed (hub remains compact until user expands)
          try {
            const activeModule =
              document
                .querySelector("#five-engine-hub .orbit-module.active")
                ?.getAttribute("data-module") || null;
            window.parent?.postMessage(
              {
                type: "nijjara-status",
                source: "closeModuleDrawer",
                module: activeModule,
                hubCompact:
                  fiveEngineHub?.classList?.contains("compact") || false,
                drawerOpen:
                  moduleDrawer?.classList?.contains("visible") || false,
                overlayVisible:
                  moduleDrawerOverlay?.classList?.contains("visible") || false,
                bodyDrawerOpen: document.body.classList.contains("drawer-open"),
                timestamp: Date.now(),
              },
              "*"
            );
          } catch (e) {
            console.warn("reportState error", e);
          }
        }

        moduleDrawerOverlay.addEventListener("click", closeModuleDrawer);
        moduleDrawerClose.addEventListener("click", closeModuleDrawer);
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModuleDrawer();
        });

        // Parent-controlled actions (for deployment validation in sandboxed iframe)
        // Allows the top-level page to trigger module drawer interactions via postMessage
        window.addEventListener("message", (e) => {
          const data = e?.data;
          if (!data || data.type !== "nijjara-action") return;
          try {
            if (data.action === "openModule" && data.module) {
              openModuleDrawer(String(data.module));
            } else if (data.action === "closeDrawer") {
              closeModuleDrawer();
            } else if (data.action === "compactOrbExpand") {
              // Expand hub (mirror of compact orb manual click)
              fiveEngineHub.classList.remove("compact");
              compactOrb.classList.remove("visible");
              // Telemetry
              window.parent?.postMessage(
                {
                  type: "nijjara-status",
                  source: "compactOrbExpand(remote)",
                  timestamp: Date.now(),
                },
                "*"
              );
            }
          } catch (err) {
            console.warn("Parent nijjara-action handler error:", err);
          }
        });

        // Ensure compact orb also closes the drawer if open
        compactOrb.addEventListener("click", () => {
          // Telemetry: user clicked compact orb while drawer may be open
          try {
            window.parent?.postMessage(
              {
                type: "nijjara-status",
                source: "compactOrbClick",
                timestamp: Date.now(),
              },
              "*"
            );
          } catch {}
          if (document.body.classList.contains("drawer-open")) {
            closeModuleDrawer();
          }
        });

        const HRM_ACTIONS = {
          "hrm-employees": [
            {
              id: "view-employees",
              icon: "#icon-eye",
              label: "ÿπÿ±ÿ∂",
              angle: -45,
            },
            {
              id: "add-employee",
              icon: "#icon-plus",
              label: "ÿ•ÿ∂ÿßŸÅÿ©",
              angle: 45,
            },
          ],
          "hrm-attendance": [
            {
              id: "view-attendance",
              icon: "#icon-eye",
              label: "ÿπÿ±ÿ∂",
              angle: -45,
            },
            {
              id: "clock-in-out",
              icon: "#icon-grid",
              label: "ÿ™ÿ≥ÿ¨ŸäŸÑ",
              angle: 45,
            },
          ],
          "hrm-deductions": [
            {
              id: "view-deductions",
              icon: "#icon-eye",
              label: "ÿπÿ±ÿ∂",
              angle: -45,
            },
            {
              id: "add-deduction",
              icon: "#icon-plus",
              label: "ÿ•ÿ∂ÿßŸÅÿ©",
              angle: 45,
            },
          ],
          "hrm-overtime": [
            {
              id: "view-overtime",
              icon: "#icon-eye",
              label: "ÿπÿ±ÿ∂",
              angle: -45,
            },
            {
              id: "add-overtime",
              icon: "#icon-plus",
              label: "ÿ•ÿ∂ÿßŸÅÿ©",
              angle: 45,
            },
          ],
          "hrm-advances": [
            {
              id: "view-advances",
              icon: "#icon-eye",
              label: "ÿπÿ±ÿ∂",
              angle: -45,
            },
            {
              id: "add-advance",
              icon: "#icon-plus",
              label: "ÿ•ÿ∂ÿßŸÅÿ©",
              angle: 45,
            },
          ],
          "hrm-payroll": [
            { id: "view-payroll", icon: "#icon-eye", label: "ÿπÿ±ÿ∂", angle: -45 },
            {
              id: "process-payroll",
              icon: "#icon-grid",
              label: "ŸÖÿπÿßŸÑÿ¨ÿ©",
              angle: 45,
            },
          ],
        };

        /**
         * Create a FAB with rays
         * @param {string} moduleId - Module identifier (hrm, prj, fin, sys)
         * @param {string} mainIconHref - SVG icon reference for main button
         * @param {Array} rays - Array of ray configurations
         * @param {number} level - FAB hierarchy level (1 or 2)
         * @param {number} x - X position
         * @param {number} y - Y position
         */
        function createFAB(
          moduleId,
          mainIconHref,
          rays,
          level = 1,
          x = null,
          y = null
        ) {
          const fabId = `fab-${fabIdCounter++}`;

          // Create FAB container
          const fab = document.createElement("div");
          fab.className = "fab";
          fab.id = fabId;
          fab.dataset.module = moduleId;
          fab.dataset.level = level;

          // Position
          if (x !== null && y !== null) {
            fab.style.left = `${x}px`;
            fab.style.top = `${y}px`;
          } else {
            // Default position (right side)
            fab.style.left = `calc(100vw - 100px)`;
            fab.style.top = `calc(100vh - 200px)`;
          }

          // Main button
          const mainButton = document.createElement("div");
          mainButton.className = "fab-button";
          mainButton.innerHTML = `<svg><use href="${mainIconHref}"></use></svg>`;
          fab.appendChild(mainButton);

          // Make draggable
          makeFabDraggable(fab, mainButton);

          // Rays container
          const raysContainer = document.createElement("div");
          raysContainer.className = "fab-rays";

          rays.forEach((ray, index) => {
            const rayEl = document.createElement("div");
            rayEl.className = "fab-ray";

            // Calculate position based on angle
            const distance = level === 1 ? 120 : 100;
            const angleRad = (ray.angle * Math.PI) / 180;
            const rayX = Math.cos(angleRad) * distance;
            const rayY = Math.sin(angleRad) * distance;

            rayEl.style.transform = `translate(${rayX}px, ${rayY}px)`;

            // Ray button
            const rayButton = document.createElement("div");
            rayButton.className = "fab-ray-button";
            rayButton.dataset.rayId = ray.id;
            rayButton.innerHTML = `<svg><use href="${ray.icon}"></use></svg>`;

            // Ray label
            const rayLabel = document.createElement("div");
            rayLabel.className = "fab-ray-label";
            rayLabel.textContent = ray.label;

            // Position label based on ray angle
            if (ray.angle < 0) {
              rayLabel.style.bottom = "110%";
              rayLabel.style.left = "50%";
              rayLabel.style.transform = "translateX(-50%)";
            } else {
              rayLabel.style.top = "110%";
              rayLabel.style.left = "50%";
              rayLabel.style.transform = "translateX(-50%)";
            }

            rayButton.addEventListener("click", (e) => {
              e.stopPropagation();
              handleRayClick(ray.id, moduleId, level, fab, rayButton);
            });

            rayEl.appendChild(rayButton);
            rayEl.appendChild(rayLabel);
            raysContainer.appendChild(rayEl);
          });

          fab.appendChild(raysContainer);
          fabContainer.appendChild(fab);

          // Register FAB
          fabRegistry.set(fabId, {
            element: fab,
            moduleId: moduleId,
            level: level,
            parentRayId: null,
          });

          // Show FAB
          fab.style.display = "block";

          logToConsole(
            `Created FAB: ${fabId}, Module: ${moduleId}, Level: ${level}, Rays: ${rays.length}`,
            "CLIENT-INFO"
          );

          return fabId;
        }

        /**
         * Make FAB draggable
         */
        function makeFabDraggable(fab, button) {
          let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0;
          let isDragging = false;

          button.onmousedown = dragMouseDown;

          function dragMouseDown(e) {
            isDragging = false;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
            e.preventDefault();
            isDragging = true;

            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;

            fab.style.left = fab.offsetLeft - pos1 + "px";
            fab.style.top = fab.offsetTop - pos2 + "px";
          }

          function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
          }
        }

        /**
         * Handle ray click - either spawn child FAB or execute action
         */
        function handleRayClick(rayId, moduleId, level, parentFab, rayButton) {
          logToConsole(
            `Ray clicked: ${rayId}, Level: ${level}`,
            "CLIENT-EVENT"
          );

          if (level === 1) {
            // Level 1: Spawn level 2 FAB
            const actions = HRM_ACTIONS[rayId] || [];
            if (actions.length === 0) {
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", `Ÿàÿ∏ŸäŸÅÿ© ${rayId} ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±`, "info");
              return;
            }

            // Remove any existing level 2 FABs
            removeChildFABs(parentFab);

            // Calculate position near the clicked ray
            const fabRect = parentFab.getBoundingClientRect();
            const rayRect = rayButton.getBoundingClientRect();

            const childX = rayRect.left - 26; // Center the child FAB on ray button
            const childY = rayRect.top - 26;

            // Get icon from ray
            const rayIcon = rayButton
              .querySelector("svg use")
              .getAttribute("href");

            createFAB(moduleId, rayIcon, actions, 2, childX, childY);
          } else if (level === 2) {
            // Level 2: Execute action
            executeAction(rayId, moduleId);
          }
        }

        /**
         * Remove all child FABs of a parent
         */
        function removeChildFABs(parentFab) {
          const parentId = parentFab.id;
          fabRegistry.forEach((fabData, fabId) => {
            if (fabData.level === 2) {
              fabData.element.remove();
              fabRegistry.delete(fabId);
            }
          });
        }

        /**
         * Execute action when level 2 ray is clicked
         */
        function executeAction(actionId, moduleId) {
          logToConsole(`Executing action: ${actionId}`, "CLIENT-EVENT");

          // Map actions to functions
          const actionMap = {
            "view-employees": () => openEmployeesWindow("view"),
            "add-employee": () => openEmployeesWindow("add"),
            "view-attendance": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿπÿ±ÿ∂ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "clock-in-out": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "view-deductions": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿπÿ±ÿ∂ ÿßŸÑÿÆÿµŸàŸÖÿßÿ™ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "add-deduction": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿµŸÖ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "view-overtime": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ∂ÿßŸÅŸä ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "add-overtime": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ∂ÿßŸÅŸä ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "view-advances": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÑŸÅ ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "add-advance": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ŸÑŸÅÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "view-payroll": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ÿπÿ±ÿ∂ ÿßŸÑÿ±Ÿàÿßÿ™ÿ® ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
            "process-payroll": () =>
              showToast("ŸÇÿ±Ÿäÿ®ÿßŸã", "ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ±Ÿàÿßÿ™ÿ® ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±", "info"),
          };

          const action = actionMap[actionId];
          if (action) {
            action();
          } else {
            showToast("ÿÆÿ∑ÿ£", `ÿ•ÿ¨ÿ±ÿßÿ° ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ: ${actionId}`, "error");
          }
        }

        /**
         * Open or focus employees window
         */
        function openEmployeesWindow(mode) {
          let win = document.querySelector('.app-window[data-module-id="hrm"]');
          if (!win) {
            document.getElementById("module-hrm").click();
            win = document.querySelector('.app-window[data-module-id="hrm"]');
          }

          if (win) {
            bringWindowToFront(win);

            if (mode === "add") {
              const formWrapper = win.querySelector("#emp-form-wrapper");
              if (formWrapper) {
                formWrapper.style.display = "block";
                showToast("ŸÜŸÖŸàÿ∞ÿ¨", "ÿ™ŸÖ ŸÅÿ™ÿ≠ ŸÜŸÖŸàÿ∞ÿ¨ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ", "info", 1500);
              }
            } else if (mode === "view") {
              const formWrapper = win.querySelector("#emp-form-wrapper");
              if (formWrapper) {
                formWrapper.style.display = "none";
              }
              showToast("ÿπÿ±ÿ∂", "ÿ¨ÿßÿ±Ÿä ÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ", "info", 1500);
            }
          }
        }

        /**
         * Toggle FAB visibility for a module
         */
        function toggleFabForModule(moduleId) {
          fabRegistry.forEach((fabData, fabId) => {
            if (fabData.moduleId === moduleId && fabData.level === 1) {
              const fab = fabData.element;
              const isHidden = fab.style.display === "none";
              fab.style.display = isHidden ? "block" : "none";
              logToConsole(
                `Toggled FAB visibility for ${moduleId}: ${
                  isHidden ? "ON" : "OFF"
                }`,
                "CLIENT-EVENT"
              );
            }
          });
        }

        /**
         * Create module FAB (called when module window is opened)
         */
        function ensureFabExists(moduleId, mainIconHref, subModules) {
          // Check if level 1 FAB already exists
          let exists = false;
          fabRegistry.forEach((fabData) => {
            if (fabData.moduleId === moduleId && fabData.level === 1) {
              exists = true;
            }
          });

          if (!exists) {
            createFAB(moduleId, mainIconHref, subModules, 1);
          }
        }

        // --- 8. HRM Module Frontend Logic ---
        function getSessionUserId() {
          try {
            const raw = sessionStorage.getItem("nijjara_session");
            if (!raw) return null;
            const data = JSON.parse(raw);
            return data.userId || data.userID || data.USR_ID || null;
          } catch (e) {
            return null;
          }
        }

        function initHRMWindow(win) {
          const tableWrapper = win.querySelector("#emp-table-wrapper");
          const searchInput = win.querySelector("#emp-search");
          const statusFilter = win.querySelector("#emp-status-filter");
          const refreshBtn = win.querySelector("#btn-refresh-emps");
          const formWrapper = win.querySelector("#emp-form-wrapper");
          const empForm = win.querySelector("#emp-form");
          const cancelBtn = win.querySelector("#emp-form-cancel");

          if (!tableWrapper) return; // safety

          refreshBtn.addEventListener("click", () => loadEmployees(win));
          statusFilter.addEventListener("change", () => loadEmployees(win));
          searchInput.addEventListener("input", () =>
            filterEmployeeRows(tableWrapper, searchInput.value.trim())
          );
          empForm.addEventListener("submit", (e) => {
            e.preventDefault();
            handleCreateEmployee(win);
          });
          cancelBtn.addEventListener("click", () => {
            formWrapper.style.display = "none";
          });

          loadEmployees(win);
        }

        function loadEmployees(win) {
          const tableWrapper = win.querySelector("#emp-table-wrapper");
          const statusFilter = win.querySelector("#emp-status-filter");
          if (!tableWrapper) return;
          const userId = getSessionUserId();
          tableWrapper.innerHTML = `<div class="loading" style="padding:15px; text-align:center;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>`;
          const status = statusFilter ? statusFilter.value : "All";
          google.script.run
            .withSuccessHandler(function (resp) {
              if (!resp || !resp.success) {
                tableWrapper.innerHTML = `<div style='color:var(--color-accent-red); padding:15px;'>ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${
                  resp?.message || ""
                }</div>`;
                showToast(
                  "ÿÆÿ∑ÿ£",
                  resp?.message || "ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ",
                  "error"
                );
                return;
              }
              renderEmployeesTable(tableWrapper, resp.data.employees || []);
            })
            .withFailureHandler(function (err) {
              tableWrapper.innerHTML = `<div style='color:var(--color-accent-red); padding:15px;'>ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ</div>`;
              showToast("ŸÅÿ¥ŸÑ", "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ", "error");
            })
            .listEmployees(status, null, 1, 200, userId);
        }

        function renderEmployeesTable(wrapper, employees) {
          if (!employees.length) {
            wrapper.innerHTML = `<div style='padding:10px; text-align:center;'>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ŸÖŸàÿ∏ŸÅŸäŸÜ</div>`;
            return;
          }
          const headersMap = [
            { key: "EMP_ID", label: "ÿßŸÑŸÖÿπÿ±ŸÅ" },
            { key: "EMP_Name_AR", label: "ÿßŸÑÿßÿ≥ŸÖ" },
            { key: "Job_Title", label: "ÿßŸÑŸÖÿ≥ŸÖŸâ" },
            { key: "DEPT_Name", label: "ÿßŸÑŸÇÿ≥ŸÖ" },
            { key: "Hire_Date", label: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿπŸäŸäŸÜ" },
            { key: "EMP_Status", label: "ÿßŸÑÿ≠ÿßŸÑÿ©" },
          ];
          let html = `<table class='data-table'><thead><tr>`;
          headersMap.forEach((h) => {
            html += `<th>${h.label}</th>`;
          });
          html += `</tr></thead><tbody>`;
          employees.forEach((emp) => {
            html +=
              `<tr data-emp-id='${emp.EMP_ID}'>` +
              headersMap.map((h) => `<td>${emp[h.key] || ""}</td>`).join("") +
              `</tr>`;
          });
          html += `</tbody></table>`;
          wrapper.innerHTML = html;
        }

        function filterEmployeeRows(wrapper, term) {
          const rows = wrapper.querySelectorAll("tbody tr");
          const t = term.toLowerCase();
          rows.forEach((r) => {
            const text = r.textContent.toLowerCase();
            r.style.display = text.includes(t) ? "" : "none";
          });
        }

        function handleCreateEmployee(win) {
          const userId = getSessionUserId();
          const formWrapper = win.querySelector("#emp-form-wrapper");
          const form = win.querySelector("#emp-form");
          const formData = Object.fromEntries(
            Array.from(form.elements)
              .filter((el) => el.name)
              .map((el) => [el.name, el.value.trim()])
          );
          // Basic validation
          if (
            !formData.EMP_Name_EN ||
            !formData.EMP_Name_AR ||
            !formData.Job_Title ||
            !formData.DEPT_Name ||
            !formData.Hire_Date
          ) {
            showToast("ÿ™ŸÜÿ®ŸäŸá", "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©", "warning");
            return;
          }
          showToast("ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ≠ŸÅÿ∏", "ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ∏ŸÅ...", "info", 2000);
          google.script.run
            .withSuccessHandler(function (resp) {
              if (resp && resp.success) {
                showToast("ÿ™ŸÖ", "ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠", "success");
                form.reset();
                formWrapper.style.display = "none";
                loadEmployees(win);
              } else {
                showToast("ŸÅÿ¥ŸÑ", resp?.message || "ÿ™ÿπÿ∞ÿ± ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸàÿ∏ŸÅ", "error");
              }
            })
            .withFailureHandler(function (err) {
              showToast("ÿÆÿ∑ÿ£", "ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ", "error");
            })
            .createEmployee(formData, userId);
        }

        // --- 9. Task Switcher Manager ---
        function addTaskThumb(windowId, moduleId, title) {
          const thumb = taskThumbTemplate.content
            .cloneNode(true)
            .querySelector(".task-thumb");
          thumb.dataset.windowId = windowId;

          const iconHref = moduleIcons[moduleId] || "#icon-sys";
          thumb.querySelector("svg use").setAttribute("href", iconHref);

          thumb.querySelector(".task-thumb-title").textContent =
            title.substring(0, 10) + "...";

          thumb.addEventListener("click", () => {
            const windowEl = document.getElementById(windowId);
            if (windowEl) {
              bringWindowToFront(windowEl);
            }
          });

          taskSwitcher.appendChild(thumb);
        }

        function removeTaskThumb(windowId) {
          document
            .querySelector(`.task-thumb[data-window-id="${windowId}"]`)
            ?.remove();
        }

        // --- 10. Global Log Function ---
        function logToConsole(message, type = "CLIENT-INFO") {
          console.log(`[${type}] ${message}`);
        }
      });

      // Temporary auto-validation helper: if URL has ?debug=1 (passed via Apps Script template),
      // expand the hub and open the HRM module drawer automatically after load.
      window.addEventListener("load", () => {
        try {
          if (String(window.__DEBUG__) === "1") {
            // Expand hub (simulate compact orb) then open HRM drawer
            fiveEngineHub.classList.remove("compact");
            compactOrb.classList.remove("visible");
            window.parent?.postMessage(
              {
                type: "nijjara-status",
                source: "debug:autoExpandHub",
                timestamp: Date.now(),
              },
              "*"
            );
            setTimeout(() => {
              openModuleDrawer("hrm");
            }, 300);
          }
        } catch (err) {
          console.warn("Debug auto-open failed:", err);
        }
      });
    </script>
  </body>
</html>
