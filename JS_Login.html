<script>
/* ============================================
   NIJJARA ERP - LOGIN MODULE
   Handles login form, authentication flow, session management
   ============================================ */

const LoginModule = {
  // State
  isSubmitting: false,
  workspaceInitialized: false,
  userMenu: null,
  userMenuButton: null,
  userMenuDocumentHandler: null,
  
  /**
   * Safe focus helper (handles cross-origin iframe restrictions)
   * @param {HTMLElement} element - Element to focus
   */
  safeFocus: function(element) {
    try {
      if (element && typeof element.focus === 'function') {
        element.focus();
      }
    } catch (error) {
      // Silently fail - focus is blocked in iframe
      Logger.debug('Login', 'Focus blocked (expected in iframe)');
    }
  },
  
  /**
   * Initialize login module
   */
  init: function() {
    Logger.info('Login', 'Initializing login module');
    
    // Get form elements
    this.form = document.getElementById('login-form');
    this.usernameInput = document.getElementById('username');
    this.passwordInput = document.getElementById('password');
    this.rememberMeCheckbox = document.getElementById('remember-me');
    this.submitButton = this.form.querySelector('button[type="submit"]');
    this.togglePasswordButton = document.getElementById('toggle-password');
    this.errorContainer = document.getElementById('login-error');
    
    // Bind events
    this.bindEvents();
    
    // Load saved username if "Remember Me" was checked
    this.loadSavedCredentials();
    
    Logger.info('Login', 'Login module initialized');
  },
  
  /**
   * Bind event handlers
   */
  bindEvents: function() {
    // Form submission
    this.form.addEventListener('submit', (e) => {
      e.preventDefault();
      this.handleLogin();
    });
    
    // Toggle password visibility
    this.togglePasswordButton.addEventListener('click', () => {
      this.togglePasswordVisibility();
    });
    
    // Clear error on input
    this.usernameInput.addEventListener('input', () => {
      this.clearError();
      FormValidator.validateRequired(this.usernameInput);
    });
    
    this.passwordInput.addEventListener('input', () => {
      this.clearError();
      FormValidator.validateRequired(this.passwordInput);
    });
    
    // Enter key navigation
    this.usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        this.safeFocus(this.passwordInput);
      }
    });
    
    Logger.debug('Login', 'Event handlers bound');
  },
  
  /**
   * Load saved credentials from localStorage
   */
  loadSavedCredentials: function() {
    const savedUsername = Utils.getStorage('rememberedUsername');
    
    if (savedUsername) {
      this.usernameInput.value = savedUsername;
      this.rememberMeCheckbox.checked = true;
      this.safeFocus(this.passwordInput);
      Logger.debug('Login', 'Loaded saved username');
    } else {
      this.safeFocus(this.usernameInput);
    }
  },
  
  /**
   * Toggle password visibility
   */
  togglePasswordVisibility: function() {
    const type = this.passwordInput.getAttribute('type');
    const icon = this.togglePasswordButton.querySelector('.material-icons');
    
    if (type === 'password') {
      this.passwordInput.setAttribute('type', 'text');
      icon.textContent = 'visibility_off';
      this.togglePasswordButton.setAttribute('aria-label', 'إخفاء كلمة المرور');
    } else {
      this.passwordInput.setAttribute('type', 'password');
      icon.textContent = 'visibility';
      this.togglePasswordButton.setAttribute('aria-label', 'عرض كلمة المرور');
    }
    
    Logger.debug('Login', 'Password visibility toggled');
  },
  
  /**
   * Clear error message
   */
  clearError: function() {
    if (this.errorContainer) {
      this.errorContainer.style.display = 'none';
      this.errorContainer.textContent = '';
    }
  },
  
  /**
   * Show error message
   * @param {string} message - Error message to display
   */
  showError: function(message) {
    if (this.errorContainer) {
      this.errorContainer.textContent = message;
      this.errorContainer.style.display = 'block';
      this.errorContainer.setAttribute('role', 'alert');
    }
    Logger.debug('Login', 'Error displayed', message);
  },
  
  /**
   * Validate login form
   * @returns {boolean} True if valid
   */
  validateForm: function() {
    this.clearError();
    
    const usernameValid = FormValidator.validateRequired(this.usernameInput);
    const passwordValid = FormValidator.validateRequired(this.passwordInput);
    
    if (!usernameValid || !passwordValid) {
      this.showError('يرجى إدخال اسم المستخدم وكلمة المرور');
      return false;
    }
    
    return true;
  },
  
  /**
   * Handle login form submission
   */
  handleLogin: async function() {
    // Prevent double submission
    if (this.isSubmitting) {
      Logger.warn('Login', 'Form already submitting');
      return;
    }
    
    // Validate form
    if (!this.validateForm()) {
      return;
    }
    
    // Get form values
    const username = this.usernameInput.value.trim();
    const password = this.passwordInput.value;
    const rememberMe = this.rememberMeCheckbox.checked;
    
    Logger.info('Login', `Login attempt for user: ${username}`);
    
    // Set submitting state
    this.isSubmitting = true;
    this.clearError();
    Loading.buttonStart(this.submitButton, this.submitButton.innerHTML);
    
    try {
      // Call authentication API
      const clientInfo = this.buildClientInfo();
      const response = await AuthAPI.login(username, password, clientInfo);
      
      Logger.info('Login', 'Authentication successful', response);
      
      // Check if authentication succeeded
      if (response.success) {
        // Save credentials if "Remember Me" is checked
        if (rememberMe) {
          Utils.setStorage('rememberedUsername', username);
        } else {
          Utils.removeStorage('rememberedUsername');
        }
        
        // Store session data
        Session.set({
          token: response.sessionToken,
          user: response.user,
          permissions: response.permissions || [],
          expiresAt: response.expiresAt || null
        }, {
          persistent: rememberMe
        });
        
        // Store bootstrap data for workspace
        Utils.setStorage('bootstrapData', {
          tabs: response.tabs || [],
          settings: response.settings || {},
          timestamp: Date.now()
        });
        
        Logger.info('Login', 'Session created successfully');
        
        // Show success message
        showToast('تم تسجيل الدخول بنجاح', 'success', 2000);
        
        // Redirect to workspace after brief delay
        setTimeout(() => {
          this.navigateToWorkspace();
        }, 500);
        
      } else {
        // Authentication failed
        const errorMessage = response.message || 'اسم المستخدم أو كلمة المرور غير صحيحة';
        this.showError(errorMessage);
        Logger.warn('Login', 'Authentication failed', response);
        
        // Reset form
        this.passwordInput.value = '';
        this.safeFocus(this.passwordInput);
      }
      
    } catch (error) {
      Logger.error('Login', 'Login error', error);
      
      // Show user-friendly error
      this.showError('حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.');
      
      // Reset form
      this.passwordInput.value = '';
      this.safeFocus(this.passwordInput);
      
    } finally {
      // Reset submitting state
      this.isSubmitting = false;
      Loading.buttonEnd(this.submitButton);
    }
  },
  
  /**
   * Navigate to workspace view
   */
  navigateToWorkspace: function() {
    Logger.info('Login', 'Navigating to workspace');
    
    const loginView = document.getElementById('login-view');
    const workspaceView = document.getElementById('workspace-view');
    
    if (loginView && workspaceView) {
      loginView.classList.add('hidden');
      loginView.style.display = 'none';
      
      workspaceView.classList.remove('hidden');
      workspaceView.style.display = 'flex';
      
      this.setupWorkspaceHeader();
      
      // Initialize workspace (to be implemented in future)
      if (typeof WorkspaceModule !== 'undefined' && WorkspaceModule.init) {
        WorkspaceModule.init();
      }
      
      Logger.info('Login', 'Workspace view displayed');
    } else {
      Logger.error('Login', 'View elements not found');
      showToast('خطأ في عرض لوحة العمل', 'error');
    }
  }
};

/**
 * Build client context for server-side logging
 */
LoginModule.buildClientInfo = function() {
  const context = {
    userAgent: '',
    timezone: '',
    language: '',
    platform: '',
    screen: ''
  };

  try {
    if (typeof navigator !== 'undefined') {
      context.userAgent = navigator.userAgent || '';
      context.language = navigator.language || '';
      context.platform = navigator.platform || '';
    }
    if (typeof Intl !== 'undefined' && Intl.DateTimeFormat) {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      context.timezone = tz || '';
    }
    if (typeof window !== 'undefined' && window.screen) {
      context.screen = `${window.screen.width || 0}x${window.screen.height || 0}`;
    }
  } catch (error) {
    Logger.warn('Login', 'Failed to build client context', error);
  }

  return context;
};

/**
 * Prepare workspace header interactions and user context
 */
LoginModule.setupWorkspaceHeader = function() {
  const userMenuButton = document.getElementById('user-menu-button');
  const userMenu = document.getElementById('user-menu');
  const logoutLink = document.getElementById('menu-logout');

  if (!userMenuButton || !userMenu) {
    Logger.warn('Login', 'Workspace header elements missing');
    return;
  }

  this.userMenu = userMenu;
  this.userMenuButton = userMenuButton;

  if (!this.workspaceInitialized) {
    this.userMenuButton.setAttribute('aria-expanded', 'false');

    const toggleHandler = (event) => {
      event.preventDefault();
      event.stopPropagation();
      this.toggleUserMenu();
    };

    const outsideClickHandler = (event) => {
      if (!this.userMenu || !this.userMenuButton) {
        return;
      }
      if (this.userMenu.contains(event.target) || this.userMenuButton.contains(event.target)) {
        return;
      }
      this.toggleUserMenu(false);
    };

    this.userMenuButton.addEventListener('click', toggleHandler);
    document.addEventListener('click', outsideClickHandler);

    this.userMenuDocumentHandler = outsideClickHandler;

    if (logoutLink && !logoutLink.dataset.boundLogout) {
      logoutLink.addEventListener('click', (event) => {
        event.preventDefault();
        this.toggleUserMenu(false);
        handleLogout();
      });
      logoutLink.dataset.boundLogout = 'true';
    }

    this.workspaceInitialized = true;
  }

  this.toggleUserMenu(false);
  this.updateUserContext();
};

/**
 * Toggle user menu visibility
 * @param {boolean} [forceState]
 */
LoginModule.toggleUserMenu = function(forceState) {
  if (!this.userMenu || !this.userMenuButton) {
    return;
  }

  const isCurrentlyOpen = this.userMenu.classList.contains('open');
  const shouldOpen = typeof forceState === 'boolean' ? forceState : !isCurrentlyOpen;

  if (shouldOpen) {
    this.userMenu.style.display = 'block';
    this.userMenu.classList.add('open');
    this.userMenuButton.setAttribute('aria-expanded', 'true');
  } else {
    this.userMenu.style.display = 'none';
    this.userMenu.classList.remove('open');
    this.userMenuButton.setAttribute('aria-expanded', 'false');
  }
};

/**
 * Update user info displayed in the header
 */
LoginModule.updateUserContext = function() {
  const session = Session.get();
  const user = session ? session.user : null;

  const nameElement = document.getElementById('user-display-name');
  const roleElement = document.getElementById('user-role');

  if (nameElement) {
    const displayName = user && (user.displayName || user.fullName || user.name || user.username);
    nameElement.textContent = displayName || 'مستخدم النظام';
  }

  if (roleElement) {
    const role = user && (user.role || user.jobTitle || user.position);
    roleElement.textContent = role || '---';
  }
};

/**
 * Check session on page load
 */
async function checkSession() {
  Logger.info('Login', 'Checking existing session');
  
  const loginView = document.getElementById('login-view');
  const workspaceView = document.getElementById('workspace-view');
  const storedSession = Session.get();
  
  try {
    if (Session.isActive() && storedSession && storedSession.token) {
      Logger.info('Login', 'Active session found, verifying with server');
      const verification = await AuthAPI.verifySession(storedSession.token);
      if (verification && verification.valid) {
        const updatedSession = {
          ...storedSession,
          expiresAt: verification.expiresAt || storedSession.expiresAt || null
        };
        Session.set(updatedSession, {
          persistent: storedSession.persistent === true
        });
        LoginModule.navigateToWorkspace();
        showToast('مرحباً بعودتك!', 'info', 2000);
        return;
      }
      Logger.warn('Login', 'Stored session invalid or expired. Clearing session.');
      Session.clear();
      Utils.removeStorage('bootstrapData');
    }
  } catch (error) {
    Logger.warn('Login', 'Session verification failed', error);
    Session.clear();
    Utils.removeStorage('bootstrapData');
  }

  Logger.info('Login', 'No active session, showing login view');
  
  // Ensure login view is visible
  if (loginView) {
    loginView.classList.remove('hidden');
    loginView.style.display = 'block';
  }
  
  // Ensure workspace is hidden
  if (workspaceView) {
    workspaceView.classList.add('hidden');
    workspaceView.style.display = 'none';
  }
  
  // Initialize login module
  LoginModule.init();
}

/**
 * Logout function (called from user menu)
 */
async function handleLogout() {
  Logger.info('Login', 'Logout requested');
  
  const confirmed = confirm('هل تريد تسجيل الخروج؟');
  
  if (!confirmed) {
    return;
  }
  
  let rememberedUsername = null;
  
  try {
    // Preserve remembered username before clearing storage
    rememberedUsername = Utils.getStorage('rememberedUsername');

    // Call server logout (optional - to invalidate session on server)
    const activeSession = Session.get();
    await AuthAPI.logout(activeSession ? activeSession.token : null).catch(err => {
      Logger.warn('Login', 'Server logout failed, continuing client-side logout', err);
    });
    
  } catch (error) {
    Logger.error('Login', 'Logout error', error);
  } finally {
    // Clear client-side session regardless of server response
    Session.clear();
    Utils.clearStorage();
    if (rememberedUsername) {
      Utils.setStorage('rememberedUsername', rememberedUsername);
    }
    
    Logger.info('Login', 'Logout completed');
    showToast('تم تسجيل الخروج بنجاح', 'success', 2000);
    
    // Reload page to show login view
    setTimeout(() => {
      window.location.reload();
    }, 500);
  }
}

// ----------------------------------------
// INITIALIZATION
// ----------------------------------------
Logger.info('Login', 'Login module script loaded');
</script>
