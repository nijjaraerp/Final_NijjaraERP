---

## üîß **Configuration Files**

### `appsscript.json`
**Purpose**: Google Apps Script project configuration file.

**What it does**:
- Defines project metadata (timezone, dependencies)
- Specifies which Google APIs are enabled
- Controls web app deployment settings
- Sets OAuth scopes for permissions

---

## üîê **Authentication & Security**

### `Auth_Password.js`
**Purpose**: Password hashing and verification logic.

**What it handles**:
- Hashing passwords using HMAC SHA256
- Generating random salts for password security
- Verifying passwords during login
- Never stores plain-text passwords

**Key Functions**:
- `hashPassword_(password, salt)` - Creates secure password hash
- `verifyPassword_(password, hash, salt)` - Validates login attempts

---

### `Auth.js`
**Purpose**: User authentication and session management.

**What it controls**:
- Login/logout workflows
- Session token generation and validation
- Rate limiting (lockout after failed attempts)
- Writing to `SYS_Sessions` sheet

**Key Functions**:
- `authenticateUser(username, password)` - Main login function
- `createSession_(user, ipAddress)` - Creates session record
- `validateSession_(sessionToken)` - Checks if session is valid
- `revokeSession_(sessionId)` - Logs user out

**Flow**:
```
User Login ‚Üí Verify Password ‚Üí Create Session ‚Üí Return Token ‚Üí Store in SYS_Sessions
```

---

## üß† **Core System Logic**

### `Code.js`
**Purpose**: Main entry point and application router.

**What it handles**:
- `onOpen()` - Creates the admin menu in Google Sheets
- `doGet(e)` - Main web app handler (serves Login or Dashboard)
- Menu items for setup, seed, and test functions
- Opens different HTML pages based on user state

**Key Functions**:
- `onOpen()` - Admin menu initialization
- `doGet(e)` - Decides which HTML to serve (Login vs Dashboard)
- `openAuditLog()` - Opens `SYS_Audit_Log` sheet
- Test function triggers

---

### `Setup.js`
**Purpose**: **THE SINGLE SOURCE OF TRUTH** for database schema.

**What it defines**:
- Every sheet name in the system
- Every column (English headers in Row 1, Arabic headers in Row 2)
- The `ERP_SCHEMA` object that defines the entire database structure

**What it does**:
- `setupAllSheets()` - Creates or resets all sheets with bilingual headers
- Freezes the first 2 rows (headers)
- Protects headers from user edits
- Must be run after any schema changes

**Critical Rule**: To add/modify a column, edit the schema in this file, then run `setupAllSheets()`.

---

### `Seed_Data.js`
**Purpose**: Initial data population for the system.

**What it populates**:
- `POLICY_Penalties` - Late arrival penalties, absence penalties
- `POLICY_Overtime` - Overtime rates (1.5x, 2x)
- `POLICY_Salary` - Salary calculation rules
- `POLICY_Deductions` - Deduction types
- `SYS_Roles` - Admin, Manager, Supervisor roles
- `SYS_Permissions` - Permission definitions (e.g., `SYS.Users.Create`)

**Key Functions**:
- `seedAllPolicySheets()` - Seeds all 4 policy sheets
- `seedSystemRoles()` - Creates initial roles
- `seedSystemPermissions()` - Defines all permissions
- `seedAllInitialData()` - Master function that runs all seeds

**When to use**: Run once during initial setup, or after schema changes.

---

### `Utilities.js`
**Purpose**: Reusable helper functions used across the system.

**What it provides**:
- `generateId_(prefix)` - Creates unique IDs (e.g., `EMP-0001`)
- `getCurrentTimestamp_()` - Returns ISO timestamp
- `isEmpty_(value)` - Checks if a value is null/empty
- `computeHmacSha256Signature_(value, key)` - For password hashing
- `generateSalt_(length)` - Generates random salt
- `getCurrentUser_()` - Gets current user email

**Type**: Backend utility library.

---

### `Validation.js`
**Purpose**: Business logic validation (entity-specific rules).

**What it validates**:
- Email format
- Date ranges (start date < end date)
- Numeric constraints (budget > 0)
- Foreign key existence (does this employee exist?)

**Example Validators**:
- `validateEmail_(email)` - Email format check
- `validateDateRange_(startDate, endDate)` - Date logic
- `validateEmployeeExists_(empId)` - FK validation

---

### `SchemaGuard.js`
**Purpose**: Schema-level validation (field whitelisting and type checking).

**What it enforces**:
- Only allowed fields can be saved
- Field types match schema (string, number, date, boolean)
- Required fields are present
- Rejects unknown fields

**Key Function**:
- `validateEntity_(entityName, data)` - Main validation gate

**Example**:
```javascript
validateEntity_('HRM_Employees', {
  EMP_Name_EN: 'Ahmed',  // ‚úÖ Allowed
  EMP_Email: 'a@b.com',  // ‚úÖ Allowed
  RandomField: 'hack'    // ‚ùå REJECTED (not in schema)
});
```

---

### `Logging.js`
**Purpose**: Centralized logging for all server operations.

**What it writes to**:
- `SYS_Audit_Log` sheet (for critical operations)
- Apps Script Logger (for debugging)
- Console logs

**Key Functions**:
- `logInfo_(actor, action, entity, id, details)` - Info-level log
- `logError_(actor, action, entity, id, details, error)` - Error-level log
- `auditAction(params)` - Creates structured audit entry
- `logExecutionTime_(functionName, callback)` - Performance monitoring

**Log Levels**:
- `INFO` - Normal operations (Create, Update, Login)
- `ERROR` - Failed operations (Validation error, Auth failure)

**Example Log Entry**:
```
Actor: mkhoraiby@nijjara.com
Action: Create
Entity: HRM_Employees
Entity_ID: EMP-0042
Details: Employee created successfully
```

---

## üë• **Module: SYS (System Administration)**

### `SYS_Users.js`
**Purpose**: User account management.

**What it manages**:
- User CRUD operations (Create, Read, Update, Deactivate)
- Role assignment
- Password changes
- User search and listing

**Key Functions**:
- `createUser(userData)` - Creates new user with hashed password
- `updateUser(userId, updates)` - Updates user info
- `deactivateUser(userId)` - Soft-delete user
- `assignRoleToUser(userId, roleId)` - Role assignment
- `changeUserPassword(userId, newPassword)` - Password update

**Sheet**: `SYS_Users`

---

### `SYS_Permissions.js`
**Purpose**: Role-Based Access Control (RBAC) system.

**What it controls**:
- Permission checking before any operation
- Role ‚Üí Permission mapping
- Permission granting/revoking

**Key Functions**:
- `userHasPermission_(userId, permissionName)` - Checks if user can do action
- `ensurePermission_(userId, permissionName)` - Throws error if no permission
- `grantPermissionToRole(roleId, permissionId)` - Assigns permission to role
- `revokePermissionFromRole(roleId, permissionId)` - Removes permission

**Sheets Used**:
- `SYS_Roles` - Role definitions
- `SYS_Permissions` - Permission definitions
- `SYS_Role_Permissions` - Role-Permission mapping

**Example Permission Check**:
```javascript
ensurePermission_(userId, 'HRM.Employees.Create');
// If user doesn't have permission ‚Üí Error thrown ‚Üí Operation blocked
```

---

### `SYS_Documents.js`
**Purpose**: Document metadata management (stub module).

**What it tracks**:
- File uploads linked to entities
- Google Drive file IDs and URLs
- Document categories (Contracts, Invoices, etc.)

**Key Functions**:
- `createDocument(docData)` - Creates document metadata entry
- `listDocuments(entity, entityId)` - Lists docs for an entity
- `getDocumentById(docId)` - Retrieves document info
- `deleteDocument(docId)` - Removes document entry

**Sheet**: `SYS_Documents`

**Note**: Currently stores metadata only. Actual file storage in Google Drive to be implemented later.

---

## üë§ **Module: HRM (Human Resources)**

### `HRM_Employees.js`
**Purpose**: Employee master data management.

**What it manages**:
- Employee CRUD operations
- Personal info (name, email, phone, address)
- Employment info (hire date, job title, department)
- Salary and contract type

**Key Functions**:
- `createEmployee(empData)` - Adds new employee
- `updateEmployee(empId, updates)` - Updates employee info
- `getEmployeeById(empId)` - Retrieves employee record
- `listEmployees(filters)` - Lists all employees with optional filters

**Sheet**: `HRM_Employees`

---

### `HRM_Attendance.js`
**Purpose**: Daily attendance tracking.

**What it records**:
- Clock in/out times
- Total hours worked
- Late arrival minutes
- Early departure minutes
- Overtime minutes

**Key Functions**:
- `recordAttendance(attendanceData)` - Creates attendance record
- `getAttendanceByEmployee(empId, startDate, endDate)` - Gets attendance history
- `calculateOvertimeMinutes(clockIn, clockOut)` - Calculates overtime

**Sheet**: `HRM_Attendance`

**Links to**:
- `POLICY_Penalties` - For late penalties
- `POLICY_Overtime` - For overtime rates

---

### `HRM_Leave.js`
**Purpose**: Leave request management.

**What it handles**:
- Leave request submission
- Leave approval workflow
- Leave balance calculation
- Leave types (Annual, Sick, Unpaid, etc.)

**Key Functions**:
- `createLeaveRequest(leaveData)` - Submits leave request
- `approveLeave(leaveId, approverId)` - Approves request
- `rejectLeave(leaveId, approverId, reason)` - Rejects request
- `getEmployeeLeaveBalance(empId)` - Calculates remaining leave days

**Sheet**: `HRM_Leave`

**Workflow**:
```
Submit Request ‚Üí Pending ‚Üí Manager Reviews ‚Üí Approved/Rejected ‚Üí Balance Updated
```

---

### `HRM_Deductions.js`
**Purpose**: Salary deduction management.

**What it tracks**:
- Penalty-based deductions (late arrival, absence)
- Loan repayments
- Advance salary deductions
- Custom deductions

**Key Functions**:
- `createDeduction(deductionData)` - Records deduction
- `getEmployeeDeductions(empId, month, year)` - Gets monthly deductions
- `calculateTotalDeductions(empId, month, year)` - Sums all deductions

**Sheet**: `HRM_Deductions`

**Links to**:
- `POLICY_Penalties` - For penalty amounts
- `POLICY_Deductions` - For deduction rules

---

## üñ•Ô∏è **Frontend Files (HTML)**

### `Login.html`
**Purpose**: Login page UI.

**What it displays**:
- Username and password input fields
- Login button
- Error/success messages
- Beautiful gradient background with animations

**What it calls**:
```javascript
google.script.run
  .withSuccessHandler(handleSuccess)
  .withFailureHandler(handleFailure)
  .authenticateUser(username, password);
```

**Flow**:
```
User enters credentials ‚Üí Calls Auth.js ‚Üí Session created ‚Üí Redirect to Dashboard
```

---

### `Dashboard.html`
**Purpose**: Initial landing page after login (stub).

**What it shows**:
- Welcome message
- Quick stats (employees, projects, transactions)
- Module shortcuts
- User info

**Status**: Currently a placeholder, will be expanded in future phases.

---

### `NijjaraOS.html`
**Purpose**: Main Single-Page Application (SPA) shell.

**What it provides**:
- Five-Engine Hub System (circular module navigation)
- Central search bar
- Window management system (open multiple modules)
- Task switcher (bottom bar showing open windows)
- Module drawers (HRM, PRJ, FIN, SYS)
- FAB (Floating Action Button) system for quick actions

**Key UI Components**:
- **Top Control Bar**: User info, clock, logout
- **Central Hub**: 4 orbiting module buttons (HRM/PRJ/FIN/SYS)
- **Module Drawer**: Slide-out panel with submodules
- **Window System**: Draggable, resizable windows for each form/view
- **Toast Notifications**: Success/error messages

**Modules Defined**:
```javascript
HRM_SUBMODULES: Employees, Attendance, Leave, Overtime, Deductions
PRJ_SUBMODULES: Projects, Clients, Tasks, Materials, Timesheets
FIN_SUBMODULES: Expenses, Income, Invoices, Payments
SYS_SUBMODULES: Users, Roles, Permissions, Audit Log, Documents
```

---

### `index.html`
**Purpose**: Placeholder HTML file (not currently used in production).

**Note**: This file is part of the frontend icon pack development, not the main ERP system.

---

### `debug.js`
**Purpose**: Client-side logging for browser console.

**What it provides**:
- Structured console logging
- Color-coded log levels (INFO, WARN, ERROR)
- Performance timing
- Event tracking

**Example Usage**:
```javascript
DBG.log('Loading employee list...', 'CLIENT-INFO');
DBG.error('Failed to load employees', error);
```

**Complements**: Server-side `Logging.js`

---

## üìä **System Architecture Summary**

### **Data Flow**:
```
User Action (Frontend HTML)
  ‚Üì
google.script.run.myFunction()
  ‚Üì
Backend .js File (e.g., HRM_Employees.js)
  ‚Üì
Permission Check (SYS_Permissions.js)
  ‚Üì
Validation (SchemaGuard.js + Validation.js)
  ‚Üì
Database Write (Google Sheets)
  ‚Üì
Audit Log (Logging.js ‚Üí SYS_Audit_Log)
  ‚Üì
Response to Frontend
  ‚Üì
Toast Notification (NijjaraOS.html)
```

---

### **The 3-Layer Architecture**:

1. **Frontend Layer** (HTML files):
   - User interface
   - Forms and tables
   - Client-side validation
   - `google.script.run` calls

2. **Backend Layer** (.js files):
   - Server-side logic
   - CRUD operations
   - Business rules
   - Permission checks

3. **Data Layer** (Google Sheets):
   - Database tables
   - 2-row bilingual headers
   - Formula columns (Arabic)
   - Protected headers

---

## üéØ **File Usage by Phase**

### **Phase 1: Setup & Configuration**
- `Setup.js` - Define schema
- `Seed_Data.js` - Populate initial data
- `Code.js` - Admin menu

### **Phase 2: Authentication**
- `Auth_Password.js` - Password security
- `Auth.js` - Login/logout
- `Login.html` - Login UI

### **Phase 3: System Core**
- `SYS_Users.js` - User management
- `SYS_Permissions.js` - RBAC
- `SYS_Documents.js` - File tracking

### **Phase 4: HRM Module**
- `HRM_Employees.js` - Employee master
- `HRM_Attendance.js` - Clock in/out
- `HRM_Leave.js` - Leave requests
- `HRM_Deductions.js` - Salary deductions

### **Phase 5: Main UI**
- `NijjaraOS.html` - SPA shell
- `Dashboard.html` - Landing page

---

## üîë **Key Takeaways**

1. **`Setup.js`** is the **single source of truth** for database structure
2. **`Logging.js`** tracks every important operation
3. **`SYS_Permissions.js`** gates access to all operations
4. **`Auth.js`** controls who can enter the system
5. **HRM_*.js** files handle all HR operations
6. **HTML files** provide the user interface
7. **`Utilities.js`** + **`Validation.js`** support all modules

---
# End of Documentation